<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Income Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --lapsed: #ff6b6b;
            --ico: #00ffcc;
            --referral: #9d4edd;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --level1: #00ffcc;
            --level2: #00d4ff;
            --level3: #9d4edd;
            --level4: #ff6b9d;
            --level5: #ffaa00;
            --level6: #ff8c00;
            --level7: #ff5e3a;
            --level8: #ff2a6d;
            --level9: #d44eff;
            --level10: #aa55ff;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            min-height: 100vh; overflow-x: hidden; position: relative;
        }
        .crypto-bg { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-2;
            background: linear-gradient(90deg, rgba(0,255,204,0.03) 1px,transparent 1px) 0 0 /50px 50px,
                        linear-gradient(0deg, rgba(157,78,221,0.03) 1px,transparent 1px) 0 0 /50px 50px;
            animation: bgMove 20s linear infinite;
        }
        @keyframes bgMove { 0% { background-position:0 0,0 0; } 100% { background-position:100px 100px,100px 100px; } }
        .rainbow-border { position:fixed; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; z-index:1000; }
        @keyframes rainbow { 0% { background-position:0% 50%; } 50% { background-position:100% 50%; } 100% { background-position:0% 50%; } }
        .bg-glow { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:1200px; height:1200px; background:radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, transparent 70%); z-index:-2; }
        .container { max-width:1400px; margin:0 auto; padding:20px; position:relative; z-index:1; }
        .connect-btn {
            position: fixed; top:20px; right:20px; background:linear-gradient(90deg, var(--primary), var(--secondary)); color:#000; border:none; border-radius:15px; padding:12px 25px; font-weight:800; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:10px; box-shadow:0 4px 20px rgba(0,255,204,0.3); z-index:1001;
        }
        .connect-btn.connected { background:rgba(0,255,204,0.1); color:var(--primary); border:1px solid var(--primary); }
        .back-btn { display:inline-flex; align-items:center; gap:10px; color:var(--primary); text-decoration:none; font-weight:600; margin-bottom:20px; padding:10px 20px; border-radius:12px; background:rgba(0,255,204,0.1); border:1px solid rgba(0,255,204,0.3); }
        .header { text-align:center; margin-bottom:30px; }
        .header h1 { background:var(--gradient); -webkit-background-clip:text; background-clip:text; color:transparent; font-size:48px; font-weight:800; margin-bottom:10px; animation:rainbow 8s ease infinite; }
        .header p { color:#aaa; font-size:16px; }
        .stats-container { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:rgba(22,24,33,0.7); backdrop-filter:blur(10px); border-radius:20px; padding:25px; border:1px solid rgba(0,255,204,0.1); position:relative; overflow:hidden; }
        .stat-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; }
        .stat-title { display:flex; align-items:center; gap:10px; color:#aaa; font-size:14px; margin-bottom:15px; }
        .stat-value { font-size:28px; font-weight:800; color:var(--primary); margin-bottom:5px; }
        .stat-sub { font-size:14px; color:#888; }
        .income-card { background:rgba(22,24,33,0.7); backdrop-filter:blur(10px); border-radius:24px; padding:25px; border:1px solid rgba(0,255,204,0.15); margin-bottom:25px; position:relative; }
        .income-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; }
        .card-header { display:flex; align-items:center; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .card-header i { font-size:28px; color:var(--primary); }
        .card-header h2 { color:var(--primary); font-size:24px; font-weight:700; }
        .card-header span { margin-left:auto; background:rgba(0,255,204,0.1); padding:8px 16px; border-radius:30px; font-size:14px; color:var(--primary); border:1px solid rgba(0,255,204,0.3); }
        .table-responsive { overflow-x:auto; border-radius:16px; border:1px solid rgba(45,47,62,0.5); max-height:500px; overflow-y:auto; }
        table { width:100%; border-collapse:collapse; min-width:1200px; }
        thead { background:linear-gradient(90deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1)); position:sticky; top:0; z-index:10; }
        th { padding:16px 15px; text-align:left; font-weight:700; font-size:14px; color:var(--primary); text-transform:uppercase; border-bottom:2px solid rgba(0,255,204,0.2); }
        td { padding:14px 15px; border-bottom:1px solid rgba(45,47,62,0.3); font-size:14px; }
        tr:hover td { background:rgba(255,255,255,0.03); }
        .level-badge { padding:4px 10px; border-radius:20px; font-size:12px; font-weight:700; display:inline-block; min-width:70px; text-align:center; }
        .level-1 { background:rgba(0,255,204,0.1); color:var(--level1); border:1px solid rgba(0,255,204,0.3); }
        .level-2 { background:rgba(0,212,255,0.1); color:#00d4ff; border:1px solid rgba(0,212,255,0.3); }
        .level-3 { background:rgba(157,78,221,0.1); color:var(--secondary); border:1px solid rgba(157,78,221,0.3); }
        .level-4 { background:rgba(255,107,157,0.1); color:#ff6b9d; border:1px solid rgba(255,107,157,0.3); }
        .level-5 { background:rgba(255,170,0,0.1); color:#ffaa00; border:1px solid rgba(255,170,0,0.3); }
        .level-6 { background:rgba(255,140,0,0.1); color:#ff8c00; border:1px solid rgba(255,140,0,0.3); }
        .level-7 { background:rgba(255,94,58,0.1); color:#ff5e3a; border:1px solid rgba(255,94,58,0.3); }
        .level-8 { background:rgba(255,42,109,0.1); color:#ff2a6d; border:1px solid rgba(255,42,109,0.3); }
        .level-9 { background:rgba(212,78,255,0.1); color:#d44eff; border:1px solid rgba(212,78,255,0.3); }
        .level-10 { background:rgba(170,85,255,0.1); color:#aa55ff; border:1px solid rgba(170,85,255,0.3); }
        .lapsed-badge { background:rgba(255,77,77,0.15); color:var(--lapsed); border:1px solid rgba(255,77,77,0.3); }
        .wallet-addr { font-family:'Courier New', monospace; background:rgba(0,0,0,0.3); padding:6px 10px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,0.1); display:inline-block; }
        .filters { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .filter-btn { padding:12px 25px; border-radius:30px; border:1px solid var(--border); background:rgba(255,255,255,0.03); color:var(--text); cursor:pointer; font-weight:600; transition:all 0.3s; }
        .filter-btn:hover { border-color:var(--primary); color:var(--primary); }
        .filter-btn.active { background:var(--primary); color:#000; border-color:var(--primary); }
        .loading, .empty-state { text-align:center; padding:60px 20px; color:#888; }
        .loading i { font-size:24px; margin-bottom:10px; color:var(--primary); }
        .empty-state i { font-size:48px; margin-bottom:20px; color:var(--secondary); opacity:0.5; }
        .percentage { font-weight:700; color:var(--primary); }
        .reason-text { color:var(--lapsed); font-weight:600; }
        ::-webkit-scrollbar { width:8px; height:8px; }
        ::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); border-radius:4px; }
        ::-webkit-scrollbar-thumb { background:var(--gradient); border-radius:4px; animation:rainbow 8s ease infinite; }
    </style>
</head>
<body>
    <div class="crypto-bg"></div>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        
        <div class="header">
            <h1>INCOME REPORT</h1>
            <p>ICO Bonus (10% Only Once) + Team Referral (10 Levels) + Lapsed Income</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-gift"></i> ICO Bonus (10%)</div>
                <div class="stat-value" id="totalIco">0 SIG6</div>
                <div class="stat-sub" id="totalIcoUsdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-users"></i> Team Referral</div>
                <div class="stat-value" id="totalRef">0 SIG6</div>
                <div class="stat-sub" id="totalRefUsdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-exclamation-triangle"></i> Lapsed Income</div>
                <div class="stat-value" id="totalLapsed">0 SIG6</div>
                <div class="stat-sub" id="totalLapsedUsdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-chart-line"></i> Current Rate</div>
                <div class="stat-value" id="currentRate">0.0105 USDT</div>
                <div class="stat-sub" id="lastUpdated">Updating...</div>
            </div>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterIncome('all')"><i class="fas fa-layer-group"></i> All Income</button>
            <button class="filter-btn" onclick="filterIncome('ico')"><i class="fas fa-gift"></i> ICO Bonus</button>
            <button class="filter-btn" onclick="filterIncome('referral')"><i class="fas fa-users"></i> Team Referral</button>
            <button class="filter-btn" onclick="filterIncome('lapsed')"><i class="fas fa-exclamation-triangle"></i> Lapsed</button>
        </div>
        
        <!-- ICO Bonus Card -->
        <div class="income-card" id="icoCard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>ICO Bonus (10% Extra on First Buy Only)</h2>
                <span id="icoCount">0 transactions</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Transaction</th>
                            <th>Bonus %</th>
                            <th>Amount (SIG6)</th>
                            <th>USDT Value</th>
                            <th>Rate at Buy</th>
                        </tr>
                    </thead>
                    <tbody id="icoTableBody">
                        <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Loading ICO bonus...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Team Referral Card -->
        <div class="income-card" id="referralCard">
            <div class="card-header">
                <i class="fas fa-sitemap"></i>
                <h2>Team Referral Income (10 Levels)</h2>
                <span id="refCount">0 transactions</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>From Wallet</th>
                            <th>Level</th>
                            <th>Reward %</th>
                            <th>Amount (SIG6)</th>
                            <th>USDT Value</th>
                        </tr>
                    </thead>
                    <tbody id="refTableBody">
                        <tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Loading referral income...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Lapsed Income Card -->
        <div class="income-card" id="lapsedCard">
            <div class="card-header">
                <i class="fas fa-clock"></i>
                <h2>Lapsed Income (Missed Referrals)</h2>
                <span id="lapsedCount">0 transactions</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>From Wallet</th>
                            <th>To Wallet</th>
                            <th>Level</th>
                            <th>Reason</th>
                            <th>Amount Lost (SIG6)</th>
                            <th>USDT Value</th>
                        </tr>
                    </thead>
                    <tbody id="lapsedTableBody">
                        <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Loading lapsed income...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========== CONTRACT CONFIGURATION ==========
        const SIGMA_ADDR = "0x6024c57518bb116ac199EAD176486354635BFC46";
        const CREATOR_WALLET = "0xb579377DDe2C03b2b46B5b12453F4dbAddB06f2E";
        
        // Complete ABI based on your contract
        const SIGMA_ABI = [
            // View Functions
            "function balanceOf(address) view returns (uint256)",
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function users(address) view returns (address upline, uint256 referralExpiry, uint256 totalReferralEarned, uint256 lastBuyTimestamp, uint256 directCount, bool isMigrated, bool hasBought)",
            "function levelRewards(uint256) view returns (uint256)",
            
            // Events
            "event Bought(address indexed user, uint256 usdtAmount, uint256 sigmaAmount, uint256 rate, uint256 timestamp)",
            "event ReferralPaid(address indexed from, address indexed to, uint256 amount, uint256 level, uint256 timestamp)",
            "event IncomeLapsed(address indexed from, address indexed to, uint256 amount, uint256 level, string reason, uint256 timestamp)"
        ];

        let provider, signer, userAddress;
        let sigmaContract;
        let isConnected = false;
        let currentRate = 0.0105;
        let sellRate = 0.0100;
        
        // Income data arrays
        let icoIncome = [];
        let referralIncome = [];
        let lapsedIncome = [];
        
        // Level rewards percentages (from contract - basis points to percentage)
        const levelRewards = [10.00, 4.00, 3.00, 2.00, 1.00, 0.50, 0.50, 0.50, 0.50, 0.50]; // percentages
        
        window.onload = async () => {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_accounts", []);
                if (accounts.length > 0) await connectWallet();
            }
        };
        
        async function connectWallet() {
            if (!window.ethereum) { 
                alert("Please install MetaMask!"); 
                window.open("https://metamask.io/download/", "_blank");
                return; 
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    alert("Please switch to Polygon Mainnet");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x89' }],
                        });
                    } catch (switchError) {
                        console.log("Network switch error:", switchError);
                    }
                }
                
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                signer = await provider.getSigner();
                
                sigmaContract = new ethers.Contract(SIGMA_ADDR, SIGMA_ABI, provider);
                
                isConnected = true;
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('btn-text').innerText = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                
                await loadIncomeData();
                
                // Auto-refresh every 30 seconds
                setInterval(async () => {
                    if (isConnected) {
                        await loadIncomeData();
                    }
                }, 30000);
                
                window.ethereum.on('accountsChanged', async (acc) => {
                    if (acc.length) { 
                        userAddress = acc[0].toLowerCase(); 
                        await loadIncomeData(); 
                    } else {
                        window.location.reload();
                    }
                });
                
            } catch (error) {
                console.error("Connection error:", error);
                alert("Connection failed: " + error.message);
            }
        }
        
        async function loadIncomeData() {
            if (!userAddress || !sigmaContract) return;
            
            try {
                // Get current rates
                try {
                    const rateBN = await sigmaContract.currentRate();
                    const sellRateBN = await sigmaContract.getSellRate();
                    currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    sellRate = parseFloat(ethers.formatUnits(sellRateBN, 6));
                    
                    document.getElementById('currentRate').innerText = currentRate.toFixed(4) + ' USDT';
                } catch (e) {
                    console.log("Rate fetch error:", e);
                }
                
                // ===== FETCH BOUGHT EVENTS (for ICO Bonus) =====
                console.log("ðŸ” Fetching Bought events...");
                const boughtFilter = sigmaContract.filters.Bought(userAddress);
                const boughtEvents = await sigmaContract.queryFilter(boughtFilter, 0, 'latest');
                
                icoIncome = [];
                
                // Sort events by timestamp (oldest first) to find first buy
                const sortedEvents = boughtEvents.sort((a, b) => 
                    Number(a.args.timestamp) - Number(b.args.timestamp)
                );
                
                // Track if we've already added ICO bonus
                let hasAddedICO = false;
                
                for (const event of sortedEvents) {
                    const timestamp = Number(event.args.timestamp);
                    const sigmaAmount = parseFloat(ethers.formatEther(event.args.sigmaAmount));
                    const usdtAmount = parseFloat(ethers.formatUnits(event.args.usdtAmount, 6));
                    const rateAtBuy = parseFloat(ethers.formatUnits(event.args.rate, 6));
                    
                    // Calculate base amount WITHOUT bonus using the rate at time of buy
                    // Formula from contract: tokensToMint = (usdtAmount * 99 * 1e18) / (100 * rate)
                    const baseAmount = (usdtAmount * 99) / (100 * rateAtBuy);
                    const bonusAmount = sigmaAmount - baseAmount;
                    
                    console.log(`Buy at ${new Date(timestamp*1000).toLocaleString()}:`, {
                        usdtAmount,
                        sigmaAmount,
                        rateAtBuy,
                        baseAmount,
                        bonusAmount,
                        hasBonus: bonusAmount > 0.01
                    });
                    
                    // Only add ICO bonus ONCE for the first buy that has bonus
                    if (bonusAmount > 0.01 && !hasAddedICO) {
                        icoIncome.push({
                            date: new Date(timestamp * 1000),
                            txHash: event.transactionHash,
                            percentage: 10.00,
                            amount: bonusAmount,
                            usdtValue: bonusAmount * sellRate,
                            rateAtBuy: rateAtBuy
                        });
                        
                        hasAddedICO = true;
                        console.log("âœ… Added ICO bonus for first buy");
                    }
                }
                
                // ===== FETCH REFERRAL PAID EVENTS (to = userAddress) =====
                console.log("ðŸ” Fetching ReferralPaid events...");
                const refFilter = sigmaContract.filters.ReferralPaid(null, userAddress);
                const refEvents = await sigmaContract.queryFilter(refFilter, 0, 'latest');
                
                referralIncome = [];
                for (const event of refEvents) {
                    const timestamp = Number(event.args.timestamp);
                    const from = event.args.from.toLowerCase();
                    const amount = parseFloat(ethers.formatEther(event.args.amount));
                    const level = Number(event.args.level);
                    
                    // Get level reward percentage
                    let percentage = 0;
                    if (level >= 1 && level <= 10) {
                        percentage = levelRewards[level - 1];
                    }
                    
                    referralIncome.push({
                        date: new Date(timestamp * 1000),
                        txHash: event.transactionHash,
                        from: from,
                        fromShort: from.slice(0,6) + '...' + from.slice(-4),
                        level: level,
                        percentage: percentage,
                        amount: amount,
                        usdtValue: amount * sellRate
                    });
                }
                
                // ===== FETCH INCOME LAPSED EVENTS (to = userAddress) =====
                console.log("ðŸ” Fetching IncomeLapsed events...");
                const lapseFilter = sigmaContract.filters.IncomeLapsed(null, userAddress);
                const lapseEvents = await sigmaContract.queryFilter(lapseFilter, 0, 'latest');
                
                lapsedIncome = [];
                for (const event of lapseEvents) {
                    const timestamp = Number(event.args.timestamp);
                    const from = event.args.from.toLowerCase();
                    const amount = parseFloat(ethers.formatEther(event.args.amount));
                    const level = Number(event.args.level);
                    const reason = event.args.reason;
                    
                    lapsedIncome.push({
                        date: new Date(timestamp * 1000),
                        txHash: event.transactionHash,
                        from: from,
                        fromShort: from.slice(0,6) + '...' + from.slice(-4),
                        to: userAddress,
                        toShort: userAddress.slice(0,6) + '...' + userAddress.slice(-4),
                        level: level,
                        reason: reason,
                        amount: amount,
                        usdtValue: amount * sellRate
                    });
                }
                
                // Update UI
                updateStats();
                renderTables();
                document.getElementById('lastUpdated').innerText = 'Last updated: ' + new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error("Error loading income data:", error);
                document.getElementById('icoTableBody').innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-exclamation-triangle"></i><br>Error loading data</td></tr>';
            }
        }
        
        function updateStats() {
            const totalIco = icoIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalRef = referralIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalLapsed = lapsedIncome.reduce((sum, i) => sum + i.amount, 0);
            
            document.getElementById('totalIco').innerText = totalIco.toFixed(2) + ' SIG6';
            document.getElementById('totalIcoUsdt').innerText = '$' + (totalIco * sellRate).toFixed(2) + ' USDT';
            
            document.getElementById('totalRef').innerText = totalRef.toFixed(2) + ' SIG6';
            document.getElementById('totalRefUsdt').innerText = '$' + (totalRef * sellRate).toFixed(2) + ' USDT';
            
            document.getElementById('totalLapsed').innerText = totalLapsed.toFixed(2) + ' SIG6';
            document.getElementById('totalLapsedUsdt').innerText = '$' + (totalLapsed * sellRate).toFixed(2) + ' USDT';
            
            document.getElementById('icoCount').innerText = icoIncome.length + ' transactions';
            document.getElementById('refCount').innerText = referralIncome.length + ' transactions';
            document.getElementById('lapsedCount').innerText = lapsedIncome.length + ' transactions';
        }
        
        function renderTables() {
            // ICO Bonus Table
            let icoHtml = '';
            if (icoIncome.length === 0) {
                icoHtml = '<tr><td colspan="6" class="empty-state"><i class="fas fa-gift"></i><br>No ICO bonus found</td></tr>';
            } else {
                icoIncome.sort((a, b) => b.date - a.date).forEach(i => {
                    icoHtml += `<tr>
                        <td>${i.date.toLocaleString()}</td>
                        <td>
                            <span class="wallet-addr" title="${i.txHash}">
                                <i class="fas fa-receipt"></i> ${i.txHash ? i.txHash.slice(0,10)+'...' : 'Self'}
                                <i class="fas fa-copy" style="margin-left:5px; cursor:pointer; opacity:0.7" onclick="copyToClipboard('${i.txHash}')" title="Copy TX Hash"></i>
                            </span>
                        </td>
                        <td><span class="percentage">${i.percentage.toFixed(2)}%</span></td>
                        <td style="color:var(--primary); font-weight:700">${i.amount.toFixed(2)} SIG6</td>
                        <td>$${i.usdtValue.toFixed(2)}</td>
                        <td>${i.rateAtBuy.toFixed(4)} USDT</td>
                    </tr>`;
                });
            }
            document.getElementById('icoTableBody').innerHTML = icoHtml;
            
            // Referral Table
            let refHtml = '';
            if (referralIncome.length === 0) {
                refHtml = '<tr><td colspan="6" class="empty-state"><i class="fas fa-users"></i><br>No referral income yet</td></tr>';
            } else {
                referralIncome.sort((a, b) => b.date - a.date).forEach(r => {
                    refHtml += `<tr>
                        <td>${r.date.toLocaleString()}</td>
                        <td>
                            <span class="wallet-addr" title="${r.from}">
                                <i class="fas fa-user"></i> ${r.fromShort}
                                <i class="fas fa-copy" style="margin-left:5px; cursor:pointer; opacity:0.7" onclick="copyAddress('${r.from}')" title="Copy address"></i>
                            </span>
                        </td>
                        <td><span class="level-badge level-${r.level}">Level ${r.level}</span></td>
                        <td><span class="percentage">${r.percentage.toFixed(2)}%</span></td>
                        <td style="color:var(--primary); font-weight:700">${r.amount.toFixed(2)} SIG6</td>
                        <td>$${r.usdtValue.toFixed(2)}</td>
                    </tr>`;
                });
            }
            document.getElementById('refTableBody').innerHTML = refHtml;
            
            // Lapsed Table
            let lapseHtml = '';
            if (lapsedIncome.length === 0) {
                lapseHtml = '<tr><td colspan="7" class="empty-state"><i class="fas fa-clock"></i><br>No lapsed income</td></tr>';
            } else {
                lapsedIncome.sort((a, b) => b.date - a.date).forEach(l => {
                    lapseHtml += `<tr>
                        <td>${l.date.toLocaleString()}</td>
                        <td>
                            <span class="wallet-addr" title="${l.from}">
                                <i class="fas fa-user"></i> ${l.fromShort}
                                <i class="fas fa-copy" style="margin-left:5px; cursor:pointer; opacity:0.7" onclick="copyAddress('${l.from}')" title="Copy address"></i>
                            </span>
                        </td>
                        <td>
                            <span class="wallet-addr" title="${l.to}">
                                <i class="fas fa-user"></i> ${l.toShort}
                            </span>
                        </td>
                        <td><span class="level-badge lapsed-badge">Level ${l.level}</span></td>
                        <td><span class="reason-text" title="${l.reason}">${l.reason.length > 30 ? l.reason.slice(0,30)+'...' : l.reason}</span></td>
                        <td style="color:var(--lapsed); font-weight:700">${l.amount.toFixed(2)} SIG6</td>
                        <td>$${l.usdtValue.toFixed(2)}</td>
                    </tr>`;
                });
            }
            document.getElementById('lapsedTableBody').innerHTML = lapseHtml;
        }
        
        function filterIncome(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const icoCard = document.getElementById('icoCard');
            const refCard = document.getElementById('referralCard');
            const lapseCard = document.getElementById('lapsedCard');
            
            if (type === 'all') {
                icoCard.style.display = 'block';
                refCard.style.display = 'block';
                lapseCard.style.display = 'block';
            } else if (type === 'ico') {
                icoCard.style.display = 'block';
                refCard.style.display = 'none';
                lapseCard.style.display = 'none';
            } else if (type === 'referral') {
                icoCard.style.display = 'none';
                refCard.style.display = 'block';
                lapseCard.style.display = 'none';
            } else if (type === 'lapsed') {
                icoCard.style.display = 'none';
                refCard.style.display = 'none';
                lapseCard.style.display = 'block';
            }
        }
        
        function copyAddress(addr) {
            navigator.clipboard.writeText(addr);
            alert("Address copied to clipboard!");
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert("Copied to clipboard!");
        }
    </script>
</body>
</html>
