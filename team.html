<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Complete Downline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --level1: #00ffcc;
            --level2: #00d4ff;
            --level3: #9d4edd;
            --level4: #ff6b9d;
            --level5: #ffaa00;
            --level6: #ff8c00;
            --level7: #ff5e3a;
            --level8: #ff2a6d;
            --level9: #d44eff;
            --level10: #aa55ff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, transparent 70%);
            z-index: -2;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,255,204,0.3);
            z-index: 1001;
        }
        
        .connect-btn.connected {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 30px;
        }
        
        .header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
            animation: rainbow 8s ease infinite;
        }
        
        .header p {
            color: #aaa;
            font-size: 16px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .stat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .stat-title i {
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-sub {
            font-size: 14px;
            color: #888;
        }
        
        .filters-container {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            margin-bottom: 30px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            color: #aaa;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-input, .filter-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 15px;
            color: var(--text);
            font-size: 14px;
        }
        
        .filter-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300ffcc' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .main-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.15);
            position: relative;
        }
        
        .main-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid rgba(45,47,62,0.5);
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0,255,204,0.2);
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(45,47,62,0.3);
            font-size: 14px;
        }
        
        tr:hover td { background: rgba(255,255,255,0.03); }
        
        .level-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }
        
        .level-1 { background: rgba(0,255,204,0.1); color: var(--level1); border: 1px solid rgba(0,255,204,0.3); }
        .level-2 { background: rgba(0,212,255,0.1); color: var(--level2); border: 1px solid rgba(0,212,255,0.3); }
        .level-3 { background: rgba(157,78,221,0.1); color: var(--level3); border: 1px solid rgba(157,78,221,0.3); }
        .level-4 { background: rgba(255,107,157,0.1); color: var(--level4); border: 1px solid rgba(255,107,157,0.3); }
        .level-5 { background: rgba(255,170,0,0.1); color: var(--level5); border: 1px solid rgba(255,170,0,0.3); }
        .level-6 { background: rgba(255,140,0,0.1); color: var(--level6); border: 1px solid rgba(255,140,0,0.3); }
        .level-7 { background: rgba(255,94,58,0.1); color: var(--level7); border: 1px solid rgba(255,94,58,0.3); }
        .level-8 { background: rgba(255,42,109,0.1); color: var(--level8); border: 1px solid rgba(255,42,109,0.3); }
        .level-9 { background: rgba(212,78,255,0.1); color: var(--level9); border: 1px solid rgba(212,78,255,0.3); }
        .level-10 { background: rgba(170,85,255,0.1); color: var(--level10); border: 1px solid rgba(170,85,255,0.3); }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: rgba(255,255,255,0.03);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-block;
        }
        
        .member-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            background: rgba(0,255,204,0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .member-badge i {
            font-size: 10px;
        }
        
        .member-badge .fa-crown {
            color: gold;
            filter: drop-shadow(0 0 2px rgba(255,215,0,0.5));
        }
        
        .member-badge .fa-star {
            color: #ffaa00;
        }
        
        .results-count {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 12px;
            background: rgba(0,255,204,0.1);
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: var(--secondary); opacity: 0.5; }
        
        .zero-balance { opacity: 0.7; }
        
        .level-filter-multiselect {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .level-chip {
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .level-chip.selected {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }
        
        .level-chip:hover {
            border-color: var(--primary);
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gradient); border-radius: 4px; animation: rainbow 8s ease infinite; }
    </style>
</head>
<body>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
            <button class="nav-btn" onclick="loadTeamData()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
        </div>
        
        <div class="header">
            <h1>COMPLETE DOWNLINE</h1>
            <p>All Team Members ‚Ä¢ 10 Levels Deep ‚Ä¢ Live Balances</p>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-users"></i> Total Team Members</div>
                <div class="stat-value" id="total-members">0</div>
                <div class="stat-sub" id="stats-breakdown">Active: 0 | Zero Balance: 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-sitemap"></i> Direct Referrals</div>
                <div class="stat-value" id="direct-referrals">0</div>
                <div class="stat-sub">Level 1 members</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-coins"></i> Team SIG6 Holdings</div>
                <div class="stat-value" id="team-sigma">0</div>
                <div class="stat-sub" id="team-sigma-usdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-chart-line"></i> Current Rates</div>
                <div class="stat-value" id="buy-rate">0.0316 USDT</div>
                <div class="stat-sub" id="sell-rate">Sell: 0.0300 USDT</div>
            </div>
        </div>
        
        <div class="filters-container">
            <div class="filters-grid">
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-layer-group"></i> Level</div>
                    <select id="level-filter" class="filter-select">
                        <option value="all">All Levels (1-10)</option>
                        <option value="1">Level 1 (Direct)</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                        <option value="6">Level 6</option>
                        <option value="7">Level 7</option>
                        <option value="8">Level 8</option>
                        <option value="9">Level 9</option>
                        <option value="10">Level 10</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-search"></i> Search</div>
                    <input type="text" id="search-address" class="filter-input" placeholder="Wallet address...">
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-filter"></i> Balance</div>
                    <select id="balance-filter" class="filter-select">
                        <option value="all">All Balances</option>
                        <option value="positive">Positive Balance Only</option>
                        <option value="zero">Zero Balance Only</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Apply</button>
                <button class="filter-btn btn-secondary" onclick="resetFilters()"><i class="fas fa-redo"></i> Reset</button>
            </div>
        </div>
        
        <div class="main-card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-sitemap"></i> TEAM NETWORK ‚Ä¢ 10 LEVELS DEEP</div>
                <div class="card-actions">
                    <button class="action-btn" onclick="sortTable('balance')"><i class="fas fa-sort-amount-down"></i> Balance</button>
                    <button class="action-btn" onclick="sortTable('date')"><i class="fas fa-sort-numeric-down"></i> Join Date</button>
                    <button class="action-btn" onclick="sortTable('level')"><i class="fas fa-sort-numeric-up"></i> Level</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-users"></i> <span id="results-text">0 members</span>
            </div>
            
            <div class="table-responsive">
                <table id="team-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Wallet Address</th>
                            <th>Level</th>
                            <th>SIG6 Balance</th>
                            <th>USDT Value</th>
                            <th>Join Date</th>
                            <th>Upline</th>
                            <th>Directs</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="team-body">
                        <tr><td colspan="10" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Connect wallet to view team</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== CONTRACT CONFIGURATION =====
        const SIGMA_ADDR = "0x52fD2a4da50d34566224DC65Da4Ba6C29c07A3DC";
        const CREATOR_WALLET = "0xb579377DDe2C03b2b46B5b12453F4dbAddB06f2E";
        
        // COMPLETE ABI
        const SIGMA_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function upline(address) view returns (address)",
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function users(address) view returns (address upline, uint256 referralExpiry, uint256 totalReferralEarned, uint256 lastBuyTimestamp, bool isMigrated, bool hasBought, uint256 directCount)",
            "event MemberJoined(address indexed user, address indexed referrer, uint256 timestamp)",
            "event Transfer(address indexed from, address indexed to, uint256 value)"
        ];

        let provider, userAddress, sigmaContract;
        let teamMembers = [];
        let filteredMembers = [];
        let buyRate = 0.0316;
        let sellRate = 0.0300;
        let currentSort = { field: 'level', order: 'asc' };
        let isLoading = false;

        window.onload = async () => {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_accounts", []);
                if (accounts.length > 0) {
                    await connectWallet();
                }
            }
        };

        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                window.open("https://metamask.io/download/", "_blank");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                
                sigmaContract = new ethers.Contract(SIGMA_ADDR, SIGMA_ABI, provider);
                
                document.getElementById('btn-text').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                await loadTeamData();
                
                window.ethereum.on('accountsChanged', async (accs) => {
                    if (accs.length > 0) {
                        userAddress = accs[0].toLowerCase();
                        document.getElementById('btn-text').textContent = 
                            userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                        await loadTeamData();
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Connection failed");
            }
        }

        // Cache for user data to avoid repeated calls
        const userCache = new Map();
        
        async function getUserData(addr) {
            if (userCache.has(addr)) return userCache.get(addr);
            
            try {
                const [balanceBN, userStruct] = await Promise.all([
                    sigmaContract.balanceOf(addr),
                    sigmaContract.users(addr).catch(() => null)
                ]);
                
                const balance = parseFloat(ethers.formatEther(balanceBN));
                
                let upline = "0x0000000000000000000000000000000000000000";
                let directCount = 0;
                let lastBuyTimestamp = 0;
                
                if (userStruct) {
                    upline = userStruct.upline?.toLowerCase() || "0x0000000000000000000000000000000000000000";
                    directCount = Number(userStruct.directCount);
                    lastBuyTimestamp = Number(userStruct.lastBuyTimestamp);
                }
                
                const data = { balance, upline, directCount, lastBuyTimestamp };
                userCache.set(addr, data);
                return data;
            } catch {
                const data = { balance: 0, upline: "0x0000000000000000000000000000000000000000", directCount: 0, lastBuyTimestamp: 0 };
                userCache.set(addr, data);
                return data;
            }
        }

        // Recursive function to get all downline members
        async function getDownlineMembers(address, currentLevel = 1, maxLevel = 10) {
            if (currentLevel > maxLevel) return [];
            
            const members = [];
            
            try {
                // Get user data for this address to find its directCount
                const userData = await getUserData(address);
                const directCount = userData.directCount;
                
                if (directCount === 0) return [];
                
                console.log(`üîç Getting downline for ${address.slice(0,8)}... at level ${currentLevel}, directCount: ${directCount}`);
                
                // We need to find all addresses that have this address as upline
                // Since we can't query by upline directly, we need to check all addresses we know
                // But for performance, we'll rely on the MemberJoined events and Transfer events we collected
                
                // This will be populated from the events
                const potentialDownline = Array.from(allAddresses || []);
                
                for (const potentialAddr of potentialDownline) {
                    if (potentialAddr === address || potentialAddr === CREATOR_WALLET.toLowerCase()) continue;
                    
                    try {
                        const potentialUserData = await getUserData(potentialAddr);
                        if (potentialUserData.upline === address) {
                            // Found a direct downline
                            console.log(`‚úÖ Found downline: ${potentialAddr.slice(0,8)}... at level ${currentLevel + 1}`);
                            
                            members.push({
                                address: potentialAddr,
                                level: currentLevel + 1,
                                ...potentialUserData
                            });
                            
                            // Recursively get their downline
                            const subMembers = await getDownlineMembers(potentialAddr, currentLevel + 1, maxLevel);
                            members.push(...subMembers);
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                }
            } catch (e) {
                console.error(`Error getting downline for ${address}:`, e);
            }
            
            return members;
        }

        let allAddresses = new Set();
        let joinDates = new Map();

        async function loadTeamData() {
            if (!userAddress || isLoading) return;
            isLoading = true;
            
            try {
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="loading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Loading complete team structure (1-10 levels)...
                    </td></tr>
                `;

                // Get current rates
                try {
                    const rateBN = await sigmaContract.currentRate();
                    const sellRateBN = await sigmaContract.getSellRate();
                    buyRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    sellRate = parseFloat(ethers.formatUnits(sellRateBN, 6));
                    
                    document.getElementById('buy-rate').textContent = buyRate.toFixed(4) + ' USDT';
                    document.getElementById('sell-rate').textContent = `Sell: ${sellRate.toFixed(4)} USDT`;
                } catch (e) {}

                // Get ALL MemberJoined events
                console.log("üîç Fetching MemberJoined events...");
                const memberFilter = sigmaContract.filters.MemberJoined();
                const memberEvents = await sigmaContract.queryFilter(memberFilter, 0, 'latest');
                
                // Get ALL Transfer events
                console.log("üîç Fetching Transfer events...");
                const transferFilter = sigmaContract.filters.Transfer();
                const transferEvents = await sigmaContract.queryFilter(transferFilter, 0, 'latest');
                
                // Collect all unique addresses
                allAddresses = new Set();
                joinDates = new Map();
                
                // Add creator
                allAddresses.add(CREATOR_WALLET.toLowerCase());
                
                // Process MemberJoined
                memberEvents.forEach(e => {
                    const user = e.args.user.toLowerCase();
                    const referrer = e.args.referrer.toLowerCase();
                    allAddresses.add(user);
                    allAddresses.add(referrer);
                    joinDates.set(user, Number(e.args.timestamp));
                });
                
                // Process Transfer events
                transferEvents.forEach(e => {
                    const from = e.args.from.toLowerCase();
                    const to = e.args.to.toLowerCase();
                    if (from !== "0x0000000000000000000000000000000000000000") allAddresses.add(from);
                    if (to !== "0x0000000000000000000000000000000000000000") allAddresses.add(to);
                });
                
                console.log(`üîç Found ${allAddresses.size} unique addresses`);
                
                // Clear cache
                userCache.clear();
                
                // First, get all Level 1 members (directly under creator)
                console.log("üîç Getting Level 1 members...");
                const creatorAddr = CREATOR_WALLET.toLowerCase();
                
                const level1Members = [];
                
                for (const addr of allAddresses) {
                    if (addr === creatorAddr) continue;
                    
                    try {
                        const userData = await getUserData(addr);
                        if (userData.upline === creatorAddr) {
                            level1Members.push({
                                address: addr,
                                level: 1,
                                ...userData
                            });
                        }
                    } catch (e) {
                        // Ignore
                    }
                }
                
                console.log(`‚úÖ Found ${level1Members.length} Level 1 members`);
                
                // Now recursively get all downline members
                teamMembers = [...level1Members];
                
                for (const member of level1Members) {
                    console.log(`üîç Getting downline for Level 1 member ${member.address.slice(0,8)}...`);
                    const downline = await getDownlineMembers(member.address, 1, 10);
                    teamMembers.push(...downline);
                }
                
                // Remove duplicates (just in case)
                const uniqueMembers = new Map();
                teamMembers.forEach(m => uniqueMembers.set(m.address, m));
                teamMembers = Array.from(uniqueMembers.values());
                
                console.log(`‚úÖ Total team members: ${teamMembers.length}`);
                
                // Add join dates from events
                teamMembers = teamMembers.map(m => ({
                    ...m,
                    joinTimestamp: joinDates.get(m.address) || m.lastBuyTimestamp || 0,
                    joinDate: (joinDates.get(m.address) || m.lastBuyTimestamp) ? 
                        new Date((joinDates.get(m.address) || m.lastBuyTimestamp) * 1000) : null,
                    isActive: m.balance >= (10 / sellRate),
                    usdtValue: m.balance * sellRate
                }));
                
                // Sort by level and balance
                teamMembers.sort((a, b) => {
                    if (a.level !== b.level) return a.level - b.level;
                    return b.balance - a.balance;
                });
                
                filteredMembers = [...teamMembers];
                
                updateStats();
                updateTeamTable();
                
            } catch (error) {
                console.error("Error loading team:", error);
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </td></tr>
                `;
            } finally {
                isLoading = false;
            }
        }

        function updateStats() {
            const total = teamMembers.length;
            const direct = teamMembers.filter(m => m.level === 1).length;
            const totalSigma = teamMembers.reduce((sum, m) => sum + m.balance, 0);
            const totalUsdt = teamMembers.reduce((sum, m) => sum + m.usdtValue, 0);
            const active = teamMembers.filter(m => m.isActive).length;
            const zeroBal = teamMembers.filter(m => m.balance === 0).length;
            
            document.getElementById('total-members').textContent = total;
            document.getElementById('stats-breakdown').innerHTML = `Active: ${active} | Zero Balance: ${zeroBal}`;
            document.getElementById('direct-referrals').textContent = direct;
            document.getElementById('team-sigma').textContent = totalSigma.toFixed(2) + ' SIG6';
            document.getElementById('team-sigma-usdt').innerHTML = '$' + totalUsdt.toFixed(2) + ' USDT';
        }

        function updateTeamTable() {
            const tbody = document.getElementById('team-body');
            const resultsDiv = document.getElementById('results-count');
            const resultsText = document.getElementById('results-text');
            
            if (filteredMembers.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-users-slash"></i><br>
                        No team members found in your network
                    </td></tr>
                `;
                resultsDiv.style.display = 'none';
                return;
            }
            
            const activeCount = filteredMembers.filter(m => m.isActive).length;
            
            // Show level distribution
            const levelCounts = {};
            for (let lvl = 1; lvl <= 10; lvl++) {
                const count = filteredMembers.filter(m => m.level === lvl).length;
                if (count > 0) levelCounts[lvl] = count;
            }
            
            let levelText = Object.entries(levelCounts)
                .map(([lvl, cnt]) => `L${lvl}:${cnt}`)
                .join(' ‚Ä¢ ');
            
            resultsDiv.style.display = 'block';
            resultsText.innerHTML = `${filteredMembers.length} members (${activeCount} active) ‚Ä¢ ${levelText}`;
            
            let html = '';
            filteredMembers.forEach((member, i) => {
                const uplineShort = member.upline === "0x0000000000000000000000000000000000000000" ? '‚Äî' : 
                    member.upline.slice(0,6) + '...' + member.upline.slice(-4);
                
                let dateDisplay = '‚Äî';
                if (member.joinTimestamp > 0) {
                    dateDisplay = member.joinDate.toLocaleDateString('en-IN', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                }
                
                // Address display - ONLY SHOW CROWN FOR 5+ DIRECTS
                let badgeHtml = '';
                if (member.directCount >= 5) {
                    badgeHtml = `<span class="member-badge" title="Senior Team Leader (${member.directCount} directs)"><i class="fas fa-crown" style="color: gold;"></i> ${member.directCount}</span>`;
                } else if (member.directCount > 0) {
                    badgeHtml = `<span class="member-badge" title="Team Leader (${member.directCount} directs)"><i class="fas fa-star" style="color: #ffaa00;"></i> ${member.directCount}</span>`;
                }
                
                const addressDisplay = `
                    <span class="wallet-address ${member.balance === 0 ? 'zero-balance' : ''}">
                        ${member.address.slice(0,8)}...${member.address.slice(-6)}
                        ${badgeHtml}
                    </span>
                `;
                
                // Balance display
                const balanceDisplay = member.balance === 0 ? 
                    `<span style="color:#888">0.00</span>` : 
                    `<span style="color:var(--primary); font-weight:700">${member.balance.toFixed(2)}</span>`;
                
                html += `
                    <tr>
                        <td>${i+1}</td>
                        <td>
                            ${addressDisplay}
                            <div style="font-size:11px; margin-top:3px">
                                <i class="fas fa-copy" onclick="copyAddress('${member.address}')" style="cursor:pointer; margin-right:8px" title="Copy"></i>
                                <i class="fas fa-external-link-alt" onclick="viewOnExplorer('${member.address}')" style="cursor:pointer" title="View"></i>
                            </div>
                        </td>
                        <td><span class="level-badge level-${member.level}">Level ${member.level}</span></td>
                        <td>${balanceDisplay}</td>
                        <td>$${member.usdtValue.toFixed(2)}</td>
                        <td>${dateDisplay}</td>
                        <td><span class="wallet-address" style="font-size:12px">${uplineShort}</span></td>
                        <td style="text-align: center; font-weight: ${member.directCount > 0 ? 'bold' : 'normal'}; color: ${member.directCount >= 5 ? 'gold' : (member.directCount > 0 ? '#ffaa00' : '#888')}">
                            ${member.directCount}
                        </td>
                        <td>
                            <span class="level-badge ${member.isActive ? 'level-1' : 'level-5'}" 
                                  style="min-width:70px">
                                ${member.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" style="padding:6px 12px" onclick="viewMember('${member.address}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function applyFilters() {
            const level = document.getElementById('level-filter').value;
            const search = document.getElementById('search-address').value.toLowerCase();
            const balanceFilter = document.getElementById('balance-filter').value;
            
            filteredMembers = teamMembers.filter(m => {
                if (level !== 'all' && m.level !== parseInt(level)) return false;
                if (search && !m.address.includes(search)) return false;
                if (balanceFilter === 'positive' && m.balance === 0) return false;
                if (balanceFilter === 'zero' && m.balance > 0) return false;
                return true;
            });
            
            sortData(filteredMembers);
            updateTeamTable();
        }

        function resetFilters() {
            document.getElementById('level-filter').value = 'all';
            document.getElementById('search-address').value = '';
            document.getElementById('balance-filter').value = 'all';
            filteredMembers = [...teamMembers];
            sortData(filteredMembers);
            updateTeamTable();
        }

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            sortData(filteredMembers);
            updateTeamTable();
        }

        function sortData(data) {
            data.sort((a, b) => {
                let comparison = 0;
                switch(currentSort.field) {
                    case 'balance':
                        comparison = b.balance - a.balance;
                        break;
                    case 'date':
                        comparison = b.joinTimestamp - a.joinTimestamp;
                        break;
                    default: // level
                        comparison = a.level - b.level;
                }
                return currentSort.order === 'asc' ? comparison : -comparison;
            });
        }

        function copyAddress(addr) { 
            navigator.clipboard.writeText(addr); 
            alert("Address copied!");
        }

        function viewOnExplorer(addr) { 
            window.open(`https://polygonscan.com/address/${addr}`, '_blank'); 
        }

        function viewMember(addr) { 
            const m = teamMembers.find(m => m.address === addr);
            if(m) {
                alert(`Member: ${addr}\nLevel: ${m.level}\nBalance: ${m.balance.toFixed(2)} SIG6\nValue: $${m.usdtValue.toFixed(2)} USDT\nDirect Referrals: ${m.directCount}`);
            }
        }

        function exportData() {
            if (!teamMembers.length) return;
            
            let csv = "Level,Address,Balance (SIG6),USDT Value,Status,Join Date,Upline,Direct Count\n";
            teamMembers.forEach(m => {
                const joinDate = m.joinTimestamp > 0 ? new Date(m.joinTimestamp*1000).toLocaleString() : '';
                csv += `${m.level},${m.address},${m.balance.toFixed(2)},${m.usdtValue.toFixed(2)},${m.isActive ? 'Active' : 'Inactive'},${joinDate},${m.upline},${m.directCount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team_downline_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
