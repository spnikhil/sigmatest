<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Complete Downline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --level1: #00ffcc;
            --level2: #00d4ff;
            --level3: #9d4edd;
            --level4: #ff6b9d;
            --level5: #ffaa00;
            --level6: #ff8c00;
            --level7: #ff5e3a;
            --level8: #ff2a6d;
            --level9: #d44eff;
            --level10: #aa55ff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* ===== CRISSCROSS LINE ANIMATION ===== */
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(90deg, rgba(0,255,204,0.03) 1px, transparent 1px) 0 0 / 50px 50px,
                        linear-gradient(0deg, rgba(157,78,221,0.03) 1px, transparent 1px) 0 0 / 50px 50px;
            animation: bgMove 20s linear infinite;
            transform-origin: center;
        }
        
        .crypto-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,42,109,0.02) 1px, transparent 1px) 0 0 / 70px 70px,
                        linear-gradient(-45deg, rgba(0,255,204,0.02) 1px, transparent 1px) 0 0 / 70px 70px;
            animation: bgMoveReverse 15s linear infinite;
            pointer-events: none;
        }
        
        @keyframes bgMove {
            0% { background-position: 0 0, 0 0; }
            100% { background-position: 100px 100px, 100px 100px; }
        }
        
        @keyframes bgMoveReverse {
            0% { background-position: 0 0, 0 0; }
            100% { background-position: -100px -100px, -100px -100px; }
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, transparent 70%);
            z-index: -1;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,255,204,0.3);
            z-index: 1001;
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .connect-btn {
                position: relative;
                top: auto;
                right: auto;
                margin: 0 auto 20px;
                width: fit-content;
            }
        }
        
        .connect-btn.connected {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 30px;
        }
        
        /* ===== FIXED: First letter caps, rest small ===== */
        .header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
            animation: rainbow 8s ease infinite;
            text-transform: lowercase;
        }
        
        .header h1::first-letter {
            text-transform: uppercase;
        }
        
        .header p {
            color: #aaa;
            font-size: 16px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(0,255,204,0.1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .stat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .stat-title i {
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-sub {
            font-size: 14px;
            color: #888;
        }
        
        .filters-container {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            margin-bottom: 30px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            color: #aaa;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-input, .filter-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 15px;
            color: var(--text);
            font-size: 14px;
            width: 100%;
        }
        
        .filter-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300ffcc' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .filter-buttons {
                flex-direction: column;
            }
        }
        
        .filter-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,204,0.3);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .main-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.15);
            position: relative;
        }
        
        .main-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .card-actions {
                width: 100%;
            }
            .action-btn {
                flex: 1;
            }
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid rgba(45,47,62,0.5);
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0,255,204,0.2);
            white-space: nowrap;
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(45,47,62,0.3);
            font-size: 14px;
        }
        
        tr:hover td { background: rgba(255,255,255,0.03); }
        
        .level-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }
        
        .level-1 { background: rgba(0,255,204,0.1); color: var(--level1); border: 1px solid rgba(0,255,204,0.3); }
        .level-2 { background: rgba(0,212,255,0.1); color: var(--level2); border: 1px solid rgba(0,212,255,0.3); }
        .level-3 { background: rgba(157,78,221,0.1); color: var(--level3); border: 1px solid rgba(157,78,221,0.3); }
        .level-4 { background: rgba(255,107,157,0.1); color: var(--level4); border: 1px solid rgba(255,107,157,0.3); }
        .level-5 { background: rgba(255,170,0,0.1); color: var(--level5); border: 1px solid rgba(255,170,0,0.3); }
        .level-6 { background: rgba(255,140,0,0.1); color: var(--level6); border: 1px solid rgba(255,140,0,0.3); }
        .level-7 { background: rgba(255,94,58,0.1); color: var(--level7); border: 1px solid rgba(255,94,58,0.3); }
        .level-8 { background: rgba(255,42,109,0.1); color: var(--level8); border: 1px solid rgba(255,42,109,0.3); }
        .level-9 { background: rgba(212,78,255,0.1); color: var(--level9); border: 1px solid rgba(212,78,255,0.3); }
        .level-10 { background: rgba(170,85,255,0.1); color: var(--level10); border: 1px solid rgba(170,85,255,0.3); }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: rgba(255,255,255,0.03);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-block;
        }
        
        .member-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            background: rgba(0,255,204,0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .member-badge i {
            font-size: 10px;
        }
        
        .member-badge .fa-crown {
            color: gold;
            filter: drop-shadow(0 0 2px rgba(255,215,0,0.5));
        }
        
        .member-badge .fa-star {
            color: #ffaa00;
        }
        
        .results-count {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 12px;
            background: rgba(0,255,204,0.1);
            border: 1px solid rgba(0,255,204,0.3);
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(0,255,204,0.2);
            transform: translateX(-5px);
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
            }
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .nav-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: var(--secondary); opacity: 0.5; }
        
        .zero-balance { opacity: 0.7; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gradient); border-radius: 4px; animation: rainbow 8s ease infinite; }
    </style>
</head>
<body>
    <div class="crypto-bg"></div>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
            <button class="nav-btn" onclick="loadTeamData()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportData()"><i class="fas fa-download"></i> Export CSV</button>
        </div>
        
        <div class="header">
            <h1>Complete downline</h1>
            <p>Your Team Members • Live Balances</p>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-users"></i> Your Team Members</div>
                <div class="stat-value" id="total-members">0</div>
                <div class="stat-sub" id="stats-breakdown">Active: 0 | Zero Balance: 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-sitemap"></i> Your Direct Referrals</div>
                <div class="stat-value" id="direct-referrals">0</div>
                <div class="stat-sub">Level 1 members</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-coins"></i> Team SIG6 Holdings</div>
                <div class="stat-value" id="team-sigma">0</div>
                <div class="stat-sub" id="team-sigma-usdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-chart-line"></i> Current Rates</div>
                <div class="stat-value" id="buy-rate">0.0105 USDT</div>
                <div class="stat-sub" id="sell-rate">Sell: 0.0100 USDT</div>
            </div>
        </div>
        
        <div class="filters-container">
            <div class="filters-grid">
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-layer-group"></i> Level</div>
                    <select id="level-filter" class="filter-select">
                        <option value="all">All Levels</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-search"></i> Search Address</div>
                    <input type="text" id="search-address" class="filter-input" placeholder="0x... or partial address">
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-filter"></i> Balance Status</div>
                    <select id="balance-filter" class="filter-select">
                        <option value="all">All Balances</option>
                        <option value="positive">Positive Balance Only</option>
                        <option value="zero">Zero Balance Only</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Apply Filters</button>
                <button class="filter-btn btn-secondary" onclick="resetFilters()"><i class="fas fa-redo-alt"></i> Reset Filters</button>
            </div>
        </div>
        
        <div class="main-card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-sitemap"></i> YOUR TEAM NETWORK</div>
                <div class="card-actions">
                    <button class="action-btn" onclick="sortTable('balance')"><i class="fas fa-sort-amount-down"></i> Balance</button>
                    <button class="action-btn" onclick="sortTable('date')"><i class="fas fa-sort-numeric-down"></i> Join Date</button>
                    <button class="action-btn" onclick="sortTable('level')"><i class="fas fa-sort-numeric-up"></i> Level</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-users"></i> <span id="results-text">0 members</span>
            </div>
            
            <div class="table-responsive">
                <table id="team-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Wallet Address</th>
                            <th>Level</th>
                            <th>SIG6 Balance</th>
                            <th>USDT Value</th>
                            <th>Join Date</th>
                            <th>Upline</th>
                            <th>Directs</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="team-body">
                        <tr><td colspan="10" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Connect wallet to view your team</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== CONTRACT CONFIGURATION =====
        const SIGMA_ADDR = "0x6024c57518bb116ac199EAD176486354635BFC46";
        const CREATOR_WALLET = "0xb579377DDe2C03b2b46B5b12453F4dbAddB06f2E";
        
        const SIGMA_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function users(address) view returns (address upline, uint256 referralExpiry, uint256 totalReferralEarned, uint256 lastBuyTimestamp, uint256 directCount, bool isMigrated, bool hasBought)",
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event Bought(address indexed user, uint256 usdtAmount, uint256 sigmaAmount, uint256 rate, uint256 timestamp)"
        ];

        let provider, userAddress, sigmaContract;
        let teamMembers = [];
        let filteredMembers = [];
        let buyRate = 0.0105;
        let sellRate = 0.0100;
        let currentSort = { field: 'level', order: 'asc' };
        let isLoading = false;
        let allUsersData = [];

        window.onload = async () => {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_accounts", []);
                if (accounts.length > 0) await connectWallet();
            }
        };

        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                window.open("https://metamask.io/download/", "_blank");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    alert("Please switch to Polygon Mainnet");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x89' }],
                        });
                    } catch (switchError) {}
                }
                
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                sigmaContract = new ethers.Contract(SIGMA_ADDR, SIGMA_ABI, provider);
                
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                await loadAllAddresses();
                await loadTeamData();
                
            } catch (error) {
                console.error(error);
                alert("Connection failed");
            }
        }

        // Load all addresses from events
        async function loadAllAddresses() {
            try {
                const transferFilter = sigmaContract.filters.Transfer();
                const transferEvents = await sigmaContract.queryFilter(transferFilter, 0, 'latest');
                
                const boughtFilter = sigmaContract.filters.Bought();
                const boughtEvents = await sigmaContract.queryFilter(boughtFilter, 0, 'latest');
                
                const addressSet = new Set();
                addressSet.add(CREATOR_WALLET.toLowerCase());
                
                transferEvents.forEach(e => {
                    const from = e.args.from.toLowerCase();
                    const to = e.args.to.toLowerCase();
                    if (from !== "0x0000000000000000000000000000000000000000") addressSet.add(from);
                    if (to !== "0x0000000000000000000000000000000000000000") addressSet.add(to);
                });
                
                boughtEvents.forEach(e => addressSet.add(e.args.user.toLowerCase()));
                
                const addresses = Array.from(addressSet);
                
                // Get data for all addresses
                allUsersData = [];
                const batchSize = 50;
                
                for (let i = 0; i < addresses.length; i += batchSize) {
                    const batch = addresses.slice(i, i + batchSize);
                    const promises = batch.map(async (addr) => {
                        try {
                            const [balanceBN, userStruct] = await Promise.all([
                                sigmaContract.balanceOf(addr),
                                sigmaContract.users(addr).catch(() => null)
                            ]);
                            
                            const balance = parseFloat(ethers.formatEther(balanceBN));
                            
                            let upline = "0x0000000000000000000000000000000000000000";
                            let directCount = 0;
                            let lastBuyTimestamp = 0;
                            
                            if (userStruct) {
                                upline = userStruct.upline?.toLowerCase() || "0x0000000000000000000000000000000000000000";
                                directCount = Number(userStruct.directCount);
                                lastBuyTimestamp = Number(userStruct.lastBuyTimestamp);
                            }
                            
                            return { address: addr, balance, upline, directCount, lastBuyTimestamp };
                        } catch {
                            return { address: addr, balance: 0, upline: "0x0000000000000000000000000000000000000000", directCount: 0, lastBuyTimestamp: 0 };
                        }
                    });
                    
                    const results = await Promise.all(promises);
                    allUsersData.push(...results);
                    
                    if (i + batchSize < addresses.length) await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log(`✅ Loaded data for ${allUsersData.length} addresses`);
                
            } catch (error) {
                console.error("Error loading addresses:", error);
            }
        }

        function getDownline(startAddress, currentLevel = 1, maxLevel = 10) {
            if (currentLevel > maxLevel) return [];
            
            const members = [];
            
            // Find all users whose upline is startAddress
            const directDownline = allUsersData.filter(u => u.upline === startAddress);
            
            for (const member of directDownline) {
                members.push({
                    ...member,
                    level: currentLevel
                });
                
                // Recursively get their downline
                const subMembers = getDownline(member.address, currentLevel + 1, maxLevel);
                members.push(...subMembers);
            }
            
            return members;
        }

        // ===== NEW: Update level filter options based on available levels =====
        function updateLevelFilterOptions() {
            const levelSelect = document.getElementById('level-filter');
            const availableLevels = new Set(teamMembers.map(m => m.level));
            
            // Clear existing options except "all"
            levelSelect.innerHTML = '<option value="all">All Levels</option>';
            
            // Add options for levels that have members
            const sortedLevels = Array.from(availableLevels).sort((a, b) => a - b);
            sortedLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `Level ${level}`;
                levelSelect.appendChild(option);
            });
        }

        async function loadTeamData() {
            if (!userAddress || isLoading || allUsersData.length === 0) return;
            isLoading = true;
            
            try {
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="loading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Loading your team structure...
                    </td></tr>
                `;

                // Get rates
                try {
                    const rateBN = await sigmaContract.currentRate();
                    const sellRateBN = await sigmaContract.getSellRate();
                    buyRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    sellRate = parseFloat(ethers.formatUnits(sellRateBN, 6));
                    
                    document.getElementById('buy-rate').textContent = buyRate.toFixed(4) + ' USDT';
                    document.getElementById('sell-rate').textContent = `Sell: ${sellRate.toFixed(4)} USDT`;
                } catch (e) {}

                // Get user's own data
                const userData = allUsersData.find(u => u.address === userAddress) || 
                               { balance: 0, upline: "0x0000000000000000000000000000000000000000", directCount: 0 };

                // Get downline starting from current user
                teamMembers = getDownline(userAddress, 1, 10);
                
                console.log(`✅ Found ${teamMembers.length} team members under ${userAddress.slice(0,8)}...`);
                
                // Add join dates and USDT values
                teamMembers = teamMembers.map(m => ({
                    ...m,
                    usdtValue: m.balance * sellRate,
                    joinDate: m.lastBuyTimestamp > 0 ? new Date(m.lastBuyTimestamp * 1000) : null,
                    isActive: m.balance > 0
                }));
                
                filteredMembers = [...teamMembers];
                
                // Update level filter options
                updateLevelFilterOptions();
                
                updateStats();
                updateTeamTable();
                
            } catch (error) {
                console.error("Error loading team:", error);
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </td></tr>
                `;
            } finally {
                isLoading = false;
            }
        }

        function updateStats() {
            const total = teamMembers.length;
            const direct = teamMembers.filter(m => m.level === 1).length;
            const totalSigma = teamMembers.reduce((sum, m) => sum + m.balance, 0);
            const totalUsdt = teamMembers.reduce((sum, m) => sum + m.usdtValue, 0);
            const active = teamMembers.filter(m => m.balance > 0).length;
            const zeroBal = teamMembers.filter(m => m.balance === 0).length;
            
            document.getElementById('total-members').textContent = total;
            document.getElementById('stats-breakdown').innerHTML = `Active: ${active} | Zero Balance: ${zeroBal}`;
            document.getElementById('direct-referrals').textContent = direct;
            document.getElementById('team-sigma').textContent = totalSigma.toFixed(2) + ' SIG6';
            document.getElementById('team-sigma-usdt').innerHTML = '$' + totalUsdt.toFixed(2) + ' USDT';
        }

        function updateTeamTable() {
            const tbody = document.getElementById('team-body');
            const resultsDiv = document.getElementById('results-count');
            
            if (filteredMembers.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-users-slash"></i><br>
                        No team members found under your wallet
                    </td></tr>
                `;
                resultsDiv.style.display = 'none';
                return;
            }
            
            const activeCount = filteredMembers.filter(m => m.balance > 0).length;
            
            resultsDiv.style.display = 'block';
            document.getElementById('results-text').innerHTML = `${filteredMembers.length} members (${activeCount} active)`;
            
            let html = '';
            filteredMembers.forEach((member, i) => {
                const uplineShort = member.upline === "0x0000000000000000000000000000000000000000" ? '—' : 
                    member.upline.slice(0,6) + '...' + member.upline.slice(-4);
                
                let dateDisplay = '—';
                if (member.lastBuyTimestamp > 0) {
                    dateDisplay = new Date(member.lastBuyTimestamp * 1000).toLocaleDateString('en-IN', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                }
                
                // Address display
                const addressDisplay = `
                    <span class="wallet-address ${member.balance === 0 ? 'zero-balance' : ''}">
                        ${member.address.slice(0,8)}...${member.address.slice(-6)}
                    </span>
                `;
                
                // Balance display
                const balanceDisplay = member.balance === 0 ? 
                    `<span style="color:#888">0.00</span>` : 
                    `<span style="color:var(--primary); font-weight:700">${member.balance.toFixed(2)}</span>`;
                
                html += `
                    <tr>
                        <td>${i+1}</td>
                        <td>
                            ${addressDisplay}
                            <div style="font-size:11px; margin-top:3px">
                                <i class="fas fa-copy" onclick="copyAddress('${member.address}')" style="cursor:pointer; margin-right:8px" title="Copy"></i>
                                <i class="fas fa-external-link-alt" onclick="viewOnExplorer('${member.address}')" style="cursor:pointer" title="View on Polygonscan"></i>
                            </div>
                        </td>
                        <td><span class="level-badge level-${member.level}">Level ${member.level}</span></td>
                        <td>${balanceDisplay}</td>
                        <td>$${member.usdtValue.toFixed(2)}</td>
                        <td>${dateDisplay}</td>
                        <td><span class="wallet-address" style="font-size:12px">${uplineShort}</span></td>
                        <td style="text-align: center;">${member.directCount}</td>
                        <td>
                            <span class="level-badge ${member.balance > 0 ? 'level-1' : 'level-5'}" style="min-width:70px">
                                ${member.balance > 0 ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" style="padding:6px 12px" onclick="viewMember('${member.address}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function applyFilters() {
            const level = document.getElementById('level-filter').value;
            const search = document.getElementById('search-address').value.toLowerCase();
            const balanceFilter = document.getElementById('balance-filter').value;
            
            filteredMembers = teamMembers.filter(m => {
                if (level !== 'all' && m.level !== parseInt(level)) return false;
                if (search && !m.address.includes(search)) return false;
                if (balanceFilter === 'positive' && m.balance === 0) return false;
                if (balanceFilter === 'zero' && m.balance > 0) return false;
                return true;
            });
            
            sortData(filteredMembers);
            updateTeamTable();
        }

        function resetFilters() {
            document.getElementById('level-filter').value = 'all';
            document.getElementById('search-address').value = '';
            document.getElementById('balance-filter').value = 'all';
            filteredMembers = [...teamMembers];
            sortData(filteredMembers);
            updateTeamTable();
        }

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            sortData(filteredMembers);
            updateTeamTable();
        }

        function sortData(data) {
            data.sort((a, b) => {
                let comparison = 0;
                switch(currentSort.field) {
                    case 'balance':
                        comparison = b.balance - a.balance;
                        break;
                    case 'date':
                        comparison = b.lastBuyTimestamp - a.lastBuyTimestamp;
                        break;
                    default: // level
                        comparison = a.level - b.level;
                }
                return currentSort.order === 'asc' ? comparison : -comparison;
            });
        }

        function copyAddress(addr) { 
            navigator.clipboard.writeText(addr); 
            alert("Address copied!");
        }

        function viewOnExplorer(addr) { 
            window.open(`https://polygonscan.com/address/${addr}`, '_blank'); 
        }

        function viewMember(addr) { 
            const m = teamMembers.find(m => m.address === addr);
            if(m) {
                alert(`Member: ${addr}\nLevel: ${m.level}\nBalance: ${m.balance.toFixed(2)} SIG6\nValue: $${m.usdtValue.toFixed(2)} USDT\nDirects: ${m.directCount}`);
            }
        }

        function exportData() {
            if (!teamMembers.length) return;
            
            let csv = "Level,Address,Balance (SIG6),USDT Value,Status,Join Date,Upline,Direct Count\n";
            teamMembers.forEach(m => {
                const joinDate = m.lastBuyTimestamp > 0 ? new Date(m.lastBuyTimestamp*1000).toLocaleString() : '';
                csv += `${m.level},${m.address},${m.balance.toFixed(2)},${m.usdtValue.toFixed(2)},${m.balance > 0 ? 'Active' : 'Inactive'},${joinDate},${m.upline},${m.directCount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team_downline_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
