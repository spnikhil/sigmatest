<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | NEXT GEN DAPP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== ROOT & BACKGROUND ========== */
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            min-height: 100vh; overflow-x: hidden; position: relative;
        }
        
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(90deg, rgba(0,255,204,0.03) 1px, transparent 1px) 0 0 / 50px 50px,
                        linear-gradient(0deg, rgba(157,78,221,0.03) 1px, transparent 1px) 0 0 / 50px 50px;
            animation: bgMove 20s linear infinite;
            transform-origin: center;
        }
        
        .crypto-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,42,109,0.02) 1px, transparent 1px) 0 0 / 70px 70px,
                        linear-gradient(-45deg, rgba(0,255,204,0.02) 1px, transparent 1px) 0 0 / 70px 70px;
            animation: bgMoveReverse 15s linear infinite;
            pointer-events: none;
        }
        
        @keyframes bgMove {
            0% { background-position: 0 0, 0 0; }
            100% { background-position: 100px 100px, 100px 100px; }
        }
        
        @keyframes bgMoveReverse {
            0% { background-position: 0 0, 0 0; }
            100% { background-position: -100px -100px, -100px -100px; }
        }
        
        .rainbow-border { position:fixed; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; z-index:1000; }
        .rainbow-glow { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:800px; height:800px; background:radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, rgba(0,11,16,0) 70%); border-radius:50%; z-index:-1; animation:pulse 6s ease-in-out infinite alternate; }
        @keyframes rainbow { 0% { background-position:0% 50%; } 50% { background-position:100% 50%; } 100% { background-position:0% 50%; } }
        @keyframes pulse { 0% { opacity:0.5; transform:translate(-50%,-50%) scale(0.9); } 100% { opacity:0.8; transform:translate(-50%,-50%) scale(1.1); } }
        
        .ticker-container { background:rgba(10,11,16,0.9); backdrop-filter:blur(10px); border-bottom:1px solid rgba(0,255,204,0.2); padding:10px 0; overflow:hidden; position:relative; z-index:10; }
        .ticker-wrapper { display:flex; width:max-content; animation:ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform:translateX(0); } 100% { transform:translateX(-50%); } }
        .ticker-item { display:flex; align-items:center; margin:0 30px; white-space:nowrap; }
        .ticker-symbol { font-weight:700; font-size:14px; color:var(--primary); margin-right:8px; }
        .ticker-price { font-weight:600; font-size:14px; }
        .ticker-change { font-weight:600; font-size:12px; margin-left:8px; padding:2px 6px; border-radius:4px; }
        .positive { color:var(--success); background:rgba(0,255,136,0.1); }
        .negative { color:var(--danger); background:rgba(255,77,77,0.1); }
        
        .container { max-width:1200px; margin:0 auto; padding:20px; display:grid; grid-template-columns:1fr 1fr; gap:30px; position:relative; z-index:1; }
        @media (max-width:992px) { .container { grid-template-columns:1fr; } }
        .left-panel, .right-panel { display:flex; flex-direction:column; gap:20px; }
        
        .connect-btn { background:linear-gradient(90deg, var(--primary), var(--secondary)); color:#000; border:none; border-radius:15px; padding:16px 30px; font-weight:800; font-size:16px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 4px 20px rgba(0,255,204,0.3); animation:float 4s ease-in-out infinite; }
        @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }
        .connect-btn:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,255,204,0.5); }
        .connect-btn.connected { background:rgba(0,255,204,0.1); color:var(--primary); border:1px solid var(--primary); }
        
        .main-card { background:rgba(22,24,33,0.8); backdrop-filter:blur(10px); border-radius:24px; padding:30px; border:1px solid rgba(0,255,204,0.2); box-shadow:0 20px 40px rgba(0,0,0,0.5); position:relative; overflow:hidden; }
        .main-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; }
        .header { text-align:center; margin-bottom:30px; }
        .header h1 { background:var(--gradient); background-size:400% 400%; -webkit-background-clip:text; background-clip:text; color:transparent; font-size:42px; font-weight:800; letter-spacing:2px; margin-bottom:8px; animation:rainbow 8s ease infinite; }
        .header p { color:#aaa; font-size:14px; letter-spacing:1px; }
        
        .stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-bottom:25px; }
        .stat-box { background:rgba(255,255,255,0.03); padding:20px; border-radius:16px; border:1px solid rgba(45,47,62,0.5); transition:all 0.3s; }
        .stat-box:hover { border-color:var(--primary); transform:translateY(-5px); box-shadow:0 10px 20px rgba(0,255,204,0.1); }
        .stat-label { font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; display:flex; align-items:center; gap:5px; }
        .stat-value { font-size:22px; font-weight:700; color:var(--primary); }
        .stat-value-inr { font-size:14px; color:#aaa; margin-top:5px; }
        
        .tabs { display:flex; gap:10px; margin-bottom:25px; background:rgba(0,0,0,0.3); padding:6px; border-radius:16px; }
        .tab { flex:1; padding:15px; text-align:center; cursor:pointer; border-radius:12px; font-weight:700; font-size:15px; color:#666; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:8px; }
        .tab.active { background:var(--primary); color:#000; box-shadow:0 4px 15px rgba(0,255,204,0.3); }
        
        .input-area { background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:18px; padding:20px; margin-bottom:20px; transition:all 0.3s; }
        .input-area:focus-within { border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,255,204,0.1); }
        .input-header { display:flex; justify-content:space-between; font-size:13px; color:#888; margin-bottom:12px; }
        input { background:transparent; border:none; color:white; font-size:32px; width:100%; outline:none; font-weight:600; }
        
        .calc-box { background:rgba(0,255,204,0.05); border:1px dashed var(--primary); border-radius:16px; padding:20px; font-size:14px; margin-bottom:20px; min-height:100px; }
        .row { display:flex; justify-content:space-between; margin-bottom:10px; }
        
        .action-btn { width:100%; padding:20px; border-radius:16px; border:none; font-weight:800; font-size:17px; cursor:pointer; transition:all 0.3s; margin-top:10px; text-transform:uppercase; background:var(--gradient); background-size:400% 400%; color:#000; animation:rainbow 8s ease infinite; }
        .action-btn:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,255,204,0.4); }
        .action-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        
        .approval-steps {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid var(--primary);
        }
        .step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .step:last-child {
            margin-bottom: 0;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }
        .step.completed .step-number {
            background: var(--success);
        }
        .step.completed .step-text {
            color: var(--success);
        }
        .step.active .step-number {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        .step-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
        }
        .step-status {
            font-size: 12px;
            color: #888;
        }
        
        .approve-btn {
            background: #ffaa00;
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .approve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,170,0,0.3);
        }
        .approve-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .contract-box { background:rgba(0,0,0,0.3); padding:20px; border-radius:16px; border:1px solid var(--secondary); margin-top:20px; display:flex; align-items:center; gap:15px; }
        .contract-info { flex:1; }
        .contract-label { font-size:12px; color:#888; margin-bottom:5px; display:flex; align-items:center; gap:8px; }
        .contract-address { font-size:14px; color:var(--secondary); font-family:monospace; word-break:break-all; }
        .copy-btn { background:linear-gradient(90deg, var(--secondary), #7b2cbf); color:white; border:none; border-radius:12px; padding:12px 20px; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; gap:8px; white-space:nowrap; }
        .copy-btn:hover { background:linear-gradient(90deg, #7b2cbf, var(--secondary)); transform:translateY(-2px); box-shadow:0 5px 15px rgba(157,78,221,0.3); }
        
        .balance-footer { margin-top:25px; padding-top:20px; border-top:1px solid var(--border); font-size:14px; }
        .balance-item { display:flex; justify-content:space-between; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .balance-item:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
        .balance-info { display:flex; flex-direction:column; align-items:flex-end; }
        .balance-inr { font-size:12px; color:#ffaa00; font-weight:600; margin-top:2px; }
        
        .menu-card { background:rgba(22,24,33,0.8); backdrop-filter:blur(10px); border-radius:24px; padding:30px; border:1px solid rgba(157,78,221,0.2); box-shadow:0 20px 40px rgba(0,0,0,0.5); }
        .menu-card h2 { color:var(--secondary); font-size:24px; margin-bottom:25px; text-align:center; }
        .menu-grid { display:grid; grid-template-columns:1fr; gap:15px; }
        .menu-btn { background:rgba(255,255,255,0.03); border:1px solid rgba(157,78,221,0.3); border-radius:16px; padding:18px; color:white; font-weight:600; font-size:16px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:flex-start; gap:15px; text-align:left; }
        .menu-btn i { font-size:20px; color:var(--secondary); }
        .menu-btn:hover { background:rgba(157,78,221,0.1); border-color:var(--secondary); transform:translateX(5px); }
        
        .transfer-panel { background:rgba(22,24,33,0.8); backdrop-filter:blur(10px); border-radius:24px; padding:30px; border:1px solid var(--primary); margin-top:20px; }
        .transfer-panel h3 { color:var(--primary); margin-bottom:20px; display:flex; align-items:center; gap:10px; }
        .token-selector { display:flex; gap:10px; margin-bottom:20px; }
        .token-opt { flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:40px; padding:12px; text-align:center; cursor:pointer; transition:all 0.2s; }
        .token-opt.active { background:var(--primary); color:#000; font-weight:700; border-color:var(--primary); }
        .addr-row { display:flex; gap:8px; margin:15px 0; align-items:center; background:rgba(0,0,0,0.3); padding:8px 16px; border-radius:40px; }
        .addr-row input { font-size:14px; padding:8px 0; }
        .small-copy { background:transparent; border:none; color:var(--primary); cursor:pointer; font-size:18px; }
        .bal-tag { color:#aaa; font-size:13px; margin-bottom:5px; }
        .max-btn { color:var(--primary); font-weight:600; cursor:pointer; }
        .transfer-btn { width:100%; background:linear-gradient(90deg, #00ff88, #00cc66); border:none; border-radius:16px; padding:16px; font-weight:800; color:#000; margin-top:15px; cursor:pointer; }
        
        .cooldown-badge { background:rgba(255,170,0,0.15); border-radius:30px; padding:4px 12px; font-size:12px; color:var(--warning); display:inline-flex; align-items:center; gap:5px; margin-left:10px; }
        .cooldown-danger { color:var(--danger); background:rgba(255,77,77,0.15); }
        
        #statusMessage { font-size:13px; text-align:center; margin-top:15px; min-height:20px; color:var(--primary); font-weight:600; }
        
        /* ===== NEW BEAUTIFUL REFERRAL BOX ===== */
        .ref-box { 
            background: linear-gradient(145deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,255,204,0.2);
            animation: glowPulse 3s ease-in-out infinite;
        }
        
        .ref-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient);
            border-radius: 22px;
            z-index: -1;
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 10px 30px rgba(0,255,204,0.2); }
            50% { box-shadow: 0 15px 40px rgba(157,78,221,0.3); }
        }
        
        .ref-box .ref-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .ref-box .ref-header i {
            font-size: 20px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .ref-box .ref-content {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .ref-box .ref-content {
                flex-direction: column;
            }
        }
        
        .ref-box .ref-input {
            flex: 1;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--primary);
            border-radius: 40px;
            padding: 14px 20px;
            color: var(--primary);
            font-family: monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            min-width: 0;
            box-shadow: 0 0 15px rgba(0,255,204,0.1);
        }
        
        .ref-box .ref-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 20px rgba(157,78,221,0.3);
        }
        
        .ref-box .ref-copy-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 40px;
            padding: 14px 30px;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,255,204,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .ref-box .ref-copy-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .ref-box .ref-copy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(157,78,221,0.4);
        }
        
        .ref-box .ref-copy-btn:hover::before {
            left: 100%;
        }
        
        .ref-box .ref-copy-btn i {
            font-size: 16px;
        }
        
        .ref-box .ref-hint {
            margin-top: 12px;
            font-size: 12px;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ref-box .ref-hint i {
            color: var(--primary);
        }
        
        .ref-box.hidden {
            display: none;
        }
        
        @media (max-width:768px) { .container { padding:15px; } .main-card, .menu-card { padding:20px; } .header h1 { font-size:32px; } .stat-value { font-size:18px; } input { font-size:26px; } }
    </style>
</head>
<body>
    <div class="crypto-bg"></div>
    <div class="crypto-particles" id="cryptoParticles"></div>
    <div class="rainbow-border"></div>
    <div class="rainbow-glow"></div>
    
    <div class="ticker-container">
        <div class="ticker-wrapper" id="tickerWrapper"></div>
    </div>
    
    <div class="container">
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
                <i class="fas fa-wallet"></i> <span id="btnText">Connect Wallet</span>
            </button>
            
            <div class="main-card">
                <div class="header">
                    <h1>SIGMA SIX</h1>
                    <p>Stable Algorithm • 5-Level Rewards</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label"><i class="fas fa-arrow-up"></i> BUY RATE</div>
                        <div class="stat-value" id="buyRate">--</div>
                        <div class="stat-value-inr" id="buyRateInr">--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label"><i class="fas fa-arrow-down"></i> SELL RATE</div>
                        <div class="stat-value" id="sellRate">--</div>
                        <div class="stat-value-inr" id="sellRateInr">--</div>
                    </div>
                </div>
                
                <!-- Cooldown Badges -->
                <div style="display:flex; gap:15px; justify-content:center; margin-bottom:10px; flex-wrap:wrap;">
                    <span id="sellCooldownBadge" class="cooldown-badge"><i class="fas fa-hourglass-half"></i> Sell cooldown: --</span>
                    <span id="buyCooldownBadge" class="cooldown-badge"><i class="fas fa-calendar-alt"></i> 30-day: --</span>
                </div>
                
                <!-- Approval Steps -->
                <div class="approval-steps" id="approvalSteps" style="display: none;">
                    <div class="step" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-text">Approve USDT</div>
                        <div class="step-status" id="step1Status">Pending</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-text">Buy SIGMA</div>
                        <div class="step-status" id="step2Status">Locked</div>
                    </div>
                </div>
                
                <!-- Approve Button -->
                <button class="approve-btn" id="approveBtn" onclick="approveUSDT()" style="display: none;">
                    <i class="fas fa-check-circle"></i> APPROVE USDT
                </button>
                
                <div class="tabs">
                    <div class="tab active" onclick="setMode('buy')" id="buyTab">
                        <i class="fas fa-shopping-cart"></i> BUY
                    </div>
                    <div class="tab" onclick="setMode('sell')" id="sellTab">
                        <i class="fas fa-coins"></i> SELL
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-header">
                        <span>Amount in SIG6</span>
                        <span style="color:var(--primary); cursor:pointer" onclick="maxAmount()">
                            <i class="fas fa-maximize"></i> MAX
                        </span>
                    </div>
                    <input type="number" id="amount" placeholder="0.00" step="any" oninput="calculate()">
                </div>
                
                <div class="calc-box" id="calculationBox">
                    <div class="row" id="calcTotalRow">
                        <span id="calcLabel">Total USDT to Pay:</span>
                        <span id="calcValue" style="color:var(--primary); font-weight:800">0.00 USDT</span>
                    </div>
                    <div class="row">
                        <span>≈ INR:</span>
                        <span id="calcInr" style="color:#ffaa00">0.00 INR</span>
                    </div>
                    <div class="row" id="uplineRow">
                        <span style="color:#888">Upline:</span>
                        <span id="uplineAddress" style="font-size:12px">None</span>
                    </div>
                </div>
                
                <!-- MAIN ACTION BUTTON -->
                <button class="action-btn" id="actionButton" onclick="executeAction()" disabled>
                    <i class="fas fa-lock"></i> CONNECT WALLET
                </button>
                
                <div id="statusMessage"></div>
                
                <!-- ===== BEAUTIFUL REFERRAL LINK BOX (ONLY THIS ADDED) ===== -->
                <div class="ref-box hidden" id="referralBox">
                    <div class="ref-header">
                        <i class="fas fa-link"></i>
                        <span>YOUR REFERRAL LINK</span>
                    </div>
                    <div class="ref-content">
                        <input type="text" class="ref-input" id="referralLink" readonly placeholder="Connect wallet to see link">
                        <button class="ref-copy-btn" onclick="copyReferral()">
                            <i class="fas fa-copy"></i> COPY LINK
                        </button>
                    </div>
                    <div class="ref-hint">
                        <i class="fas fa-info-circle"></i>
                        Share this link with friends to earn 5-level referral rewards!
                    </div>
                </div>
                
                <div class="contract-box">
                    <div class="contract-info">
                        <div class="contract-label"><i class="fas fa-file-contract"></i> CONTRACT (NEW)</div>
                        <div class="contract-address">0x5bC7581A6f7dA420e931d17bD5CaF699C033f7Fd</div>
                    </div>
                    <button class="copy-btn" onclick="copyContract()"><i class="fas fa-copy"></i> COPY</button>
                </div>
                
                <div class="balance-footer">
                    <div class="balance-item">
                        <span><i class="fas fa-dollar-sign"></i> USDT Balance:</span>
                        <span id="usdtBalance">--</span>
                    </div>
                    <div class="balance-item">
                        <span><i class="fas fa-coins"></i> SIG6 Balance:</span>
                        <div class="balance-info">
                            <span id="sigmaBalance">--</span>
                            <span id="sigmaBalanceInr" class="balance-inr">--</span>
                        </div>
                    </div>
                    <div class="balance-item">
                        <span><i class="fas fa-gas-pump"></i> POL Balance:</span>
                        <span id="polBalance">--</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:15px; background:rgba(255,255,255,0.02); padding:12px; border-radius:40px;">
                        <span style="color:#aaa"><i class="fas fa-id-card"></i> Your Wallet</span>
                        <span style="font-family:monospace; font-size:13px" id="walletAddress">Not connected</span>
                        <button onclick="copyWallet()" style="background:none; border:none; color:var(--primary); cursor:pointer">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT PANEL -->
        <div class="right-panel">
            <div class="menu-card">
                <h2><i class="fas fa-bars"></i> MENU</h2>
                <div class="menu-grid">
                    <button class="menu-btn" onclick="window.location.href='team.html'"><i class="fas fa-users"></i><div><div>Team</div><div style="font-size:12px; color:#aaa;">Referral network</div></div></button>
                    <button class="menu-btn" onclick="window.location.href='income.html'"><i class="fas fa-chart-line"></i><div><div>Income</div><div style="font-size:12px; color:#aaa;">Rewards report</div></div></button>
                    <button class="menu-btn" onclick="window.location.href='buy_sell.html'"><i class="fas fa-exchange-alt"></i><div><div>Buy/Sell History</div><div style="font-size:12px; color:#aaa;">Complete Open/Close report</div></div></button>
                    <button class="menu-btn" onclick="window.location.href='transfer.html'"><i class="fas fa-history"></i><div><div>Transfers</div><div style="font-size:12px; color:#aaa;">P2P history</div></div></button>
                </div>
            </div>
            
            <!-- WALLET TRANSFER PANEL -->
            <div class="transfer-panel">
                <h3><i class="fas fa-exchange-alt"></i> WALLET TRANSFER</h3>
                <div class="token-selector">
                    <div class="token-opt active" onclick="setTransferToken('SIG6')">SIG6</div>
                    <div class="token-opt" onclick="setTransferToken('USDT')">USDT</div>
                    <div class="token-opt" onclick="setTransferToken('POL')">POL</div>
                </div>
                <div class="addr-row">
                    <input type="text" id="recipientAddress" placeholder="0x... recipient">
                    <button class="small-copy" onclick="pasteAddress()" title="Paste"><i class="fas fa-paste"></i></button>
                </div>
                <div class="addr-row" style="justify-content:space-between">
                    <span class="bal-tag" id="transferBalance">Balance: --</span>
                    <span class="max-btn" onclick="maxTransfer()">MAX</span>
                </div>
                <input type="number" id="transferAmount" placeholder="0.00" style="font-size:28px; padding:10px 0;" step="any">
                <button class="transfer-btn" id="transferButton" onclick="executeTransfer()">
                    <i class="fas fa-paper-plane"></i> TRANSFER
                </button>
                <div style="font-size:12px; margin-top:10px; color:#aaa" id="transferStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONTRACT CONFIGURATION (UPDATED) ==========
        const SIGMA_ADDRESS = "0x5bC7581A6f7dA420e931d17bD5CaF699C033f7Fd";
        const USDT_ADDRESS = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
        const CREATOR_WALLET = "0xb579377DDe2C03b2b46B5b12453F4dbAddB06f2E";
        
        // COMPLETE ABI (EXACTLY AS IN ORIGINAL CODE)
        const SIGMA_ABI = [
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "spender",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "approve",
			"outputs": [
				{
					"internalType": "bool",
					"name": "",
					"type": "bool"
				}
			],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "emergencyWithdraw",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "_usdt",
					"type": "address"
				},
				{
					"internalType": "address",
					"name": "_creator",
					"type": "address"
				}
			],
			"stateMutability": "nonpayable",
			"type": "constructor"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "spender",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "allowance",
					"type": "uint256"
				},
				{
					"internalType": "uint256",
					"name": "needed",
					"type": "uint256"
				}
			],
			"name": "ERC20InsufficientAllowance",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "sender",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "balance",
					"type": "uint256"
				},
				{
					"internalType": "uint256",
					"name": "needed",
					"type": "uint256"
				}
			],
			"name": "ERC20InsufficientBalance",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "approver",
					"type": "address"
				}
			],
			"name": "ERC20InvalidApprover",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "receiver",
					"type": "address"
				}
			],
			"name": "ERC20InvalidReceiver",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "sender",
					"type": "address"
				}
			],
			"name": "ERC20InvalidSender",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "spender",
					"type": "address"
				}
			],
			"name": "ERC20InvalidSpender",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "owner",
					"type": "address"
				}
			],
			"name": "OwnableInvalidOwner",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "account",
					"type": "address"
				}
				],
			"name": "OwnableUnauthorizedAccount",
			"type": "error"
		},
		{
			"inputs": [],
			"name": "ReentrancyGuardReentrantCall",
			"type": "error"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "token",
					"type": "address"
				}
			],
			"name": "SafeERC20FailedOperation",
			"type": "error"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "owner",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "spender",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "Approval",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "user",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "usdtAmount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "sigmaAmount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "rate",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "timestamp",
					"type": "uint256"
				}
			],
			"name": "Bought",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_usdtAmount",
					"type": "uint256"
				},
				{
					"internalType": "address",
					"name": "_upline",
					"type": "address"
				}
			],
			"name": "buy",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "from",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "amount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "level",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "string",
					"name": "reason",
					"type": "string"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "timestamp",
					"type": "uint256"
				}
			],
			"name": "IncomeLapsed",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "address[]",
					"name": "_users",
					"type": "address[]"
				},
				{
					"internalType": "uint256[]",
					"name": "_balances",
					"type": "uint256[]"
				},
				{
					"internalType": "address[]",
					"name": "_uplines",
					"type": "address[]"
				}
			],
			"name": "migrateUsers",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "previousOwner",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "newOwner",
					"type": "address"
				}
			],
			"name": "OwnershipTransferred",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "_to",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "_amount",
					"type": "uint256"
				}
			],
			"name": "p2pTransfer",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "from",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "amount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "timestamp",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "currentRate",
					"type": "uint256"
				}
			],
			"name": "P2PTransfer",
			"type": "event"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "from",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "amount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "level",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "timestamp",
					"type": "uint256"
				}
			],
			"name": "ReferralPaid",
			"type": "event"
		},
		{
			"inputs": [],
			"name": "renounceOwnership",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "_sigmaAmount",
					"type": "uint256"
				}
			],
			"name": "sell",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "user",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "sigmaAmount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "usdtAmount",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "rate",
					"type": "uint256"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "timestamp",
					"type": "uint256"
				}
			],
			"name": "Sold",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "transfer",
			"outputs": [
				{
					"internalType": "bool",
					"name": "",
					"type": "bool"
				}
			],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "address",
					"name": "from",
					"type": "address"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"indexed": false,
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "Transfer",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "from",
					"type": "address"
				},
				{
					"internalType": "address",
					"name": "to",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "value",
					"type": "uint256"
				}
			],
			"name": "transferFrom",
			"outputs": [
				{
					"internalType": "bool",
					"name": "",
					"type": "bool"
				}
			],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "newOwner",
					"type": "address"
				}
			],
			"name": "transferOwnership",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "_upline",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "_level",
					"type": "uint256"
				}
			],
			"name": "_isEligible",
			"outputs": [
				{
					"internalType": "bool",
					"name": "",
					"type": "bool"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "owner",
					"type": "address"
				},
				{
					"internalType": "address",
					"name": "spender",
					"type": "address"
				}
			],
			"name": "allowance",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "account",
					"type": "address"
				}
			],
			"name": "balanceOf",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "BASE_RATE",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "creatorWallet",
			"outputs": [
				{
					"internalType": "address",
					"name": "",
					"type": "address"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "currentRate",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "decimals",
			"outputs": [
				{
					"internalType": "uint8",
					"name": "",
					"type": "uint8"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "getSellRate",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "INCREMENT",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"name": "levelRewards",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "MIN_USDT_FOR_REF",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "name",
			"outputs": [
				{
					"internalType": "string",
					"name": "",
					"type": "string"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "owner",
			"outputs": [
				{
					"internalType": "address",
					"name": "",
					"type": "address"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "symbol",
			"outputs": [
				{
					"internalType": "string",
					"name": "",
					"type": "string"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "totalSupply",
			"outputs": [
				{
					"internalType": "uint256",
					"name": "",
					"type": "uint256"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "usdt",
			"outputs": [
				{
					"internalType": "contract IERC20",
					"name": "",
					"type": "address"
				}
			],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "address",
					"name": "",
					"type": "address"
				}
			],
			"name": "users",
			"outputs": [
				{
					"internalType": "address",
					"name": "upline",
					"type": "address"
				},
				{
					"internalType": "uint256",
					"name": "referralExpiry",
					"type": "uint256"
				},
				{
					"internalType": "uint256",
					"name": "totalReferralEarned",
					"type": "uint256"
				},
				{
					"internalType": "uint256",
					"name": "lastBuyTimestamp",
					"type": "uint256"
				},
				{
					"internalType": "uint256",
					"name": "directCount",
					"type": "uint256"
				},
				{
					"internalType": "bool",
					"name": "isMigrated",
					"type": "bool"
				},
				{
					"internalType": "bool",
					"name": "hasBought",
					"type": "bool"
				}
			],
			"stateMutability": "view",
			"type": "function"
		}
	];

        const USDT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) external returns (bool)",
            "function transfer(address,uint256) external returns (bool)"
        ];

        // State
        let provider, signer, userAddress;
        let sigmaContract, usdtContract;
        let currentMode = 'buy';
        let buyRate = 0, sellRate = 0;
        let isConnected = false;
        let transferToken = 'SIG6';
        let lastBuyTimestamp = 0;
        let lastSellTimestamp = 0;
        let cooldownInterval;
        let currentUSDTNeeded = 0;
        let isApproved = false;

        const INR_RATE = 95;

        window.onload = async () => {
            createParticles();
            setupTicker();
            handleUplineFromURL();
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_accounts", []);
                if (accounts.length > 0) await connectWallet();
            }
            
            startCooldownTimer();
            
            setInterval(() => {
                if (isConnected) {
                    loadData();
                }
            }, 15000);
        };

        function startCooldownTimer() {
            if (cooldownInterval) clearInterval(cooldownInterval);
            cooldownInterval = setInterval(() => {
                if (isConnected) {
                    updateCooldownUI();
                }
            }, 1000);
        }

        function createParticles() {
            const container = document.getElementById('cryptoParticles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                container.appendChild(p);
            }
        }

        function setupTicker() {
            const wrapper = document.getElementById('tickerWrapper');
            const symbols = ['BTC', 'ETH', 'BNB', 'SOL', 'ADA', 'DOT', 'MATIC', 'LINK'];
            wrapper.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const symbol = symbols[i % symbols.length];
                const price = (Math.random() * 1000 + 100).toFixed(2);
                const change = (Math.random() * 10 - 5).toFixed(2);
                const cls = parseFloat(change) >= 0 ? 'positive' : 'negative';
                wrapper.innerHTML += `
                    <div class="ticker-item">
                        <span class="ticker-symbol">${symbol}</span>
                        <span class="ticker-price">$${price}</span>
                        <span class="ticker-change ${cls}">${change}%</span>
                    </div>
                `;
            }
        }

        function handleUplineFromURL() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref');
            if (ref && ethers.isAddress(ref)) {
                localStorage.setItem('sigma_referrer', ref);
            }
            const storedRef = localStorage.getItem('sigma_referrer') || CREATOR_WALLET;
            document.getElementById('uplineAddress').textContent = 
                storedRef.slice(0,8) + '...' + storedRef.slice(-6);
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask not installed!");
                window.open("https://metamask.io/download/", "_blank");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    alert("Please switch to Polygon Mainnet");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x89' }],
                        });
                    } catch (switchError) {
                        console.log("Network switch error:", switchError);
                    }
                }
                
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                signer = await provider.getSigner();
                
                sigmaContract = new ethers.Contract(SIGMA_ADDRESS, SIGMA_ABI, signer);
                usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                
                isConnected = true;
                
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('btnText').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0,8) + '...' + userAddress.slice(-6);
                
                if (userAddress === CREATOR_WALLET.toLowerCase()) {
                    document.getElementById('statusMessage').innerHTML = 
                        '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> ⚠️ Creator Wallet detected! Cannot trade.';
                }
                
                const saved = localStorage.getItem(`lastSell_${userAddress}`);
                if (saved) {
                    lastSellTimestamp = parseInt(saved);
                }
                
                await loadData();
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
            } catch (error) {
                console.error("Connection error:", error);
                alert("Connection failed: " + error.message);
            }
        }

        async function handleAccountsChanged(accounts) {
            if (accounts.length > 0) {
                userAddress = accounts[0].toLowerCase();
                document.getElementById('btnText').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                
                if (userAddress === CREATOR_WALLET.toLowerCase()) {
                    document.getElementById('statusMessage').innerHTML = 
                        '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> ⚠️ Creator Wallet detected! Cannot trade.';
                } else {
                    document.getElementById('statusMessage').innerHTML = '';
                }
                
                const saved = localStorage.getItem(`lastSell_${userAddress}`);
                if (saved) {
                    lastSellTimestamp = parseInt(saved);
                } else {
                    lastSellTimestamp = 0;
                }
                
                await loadData();
            } else {
                disconnectWallet();
            }
        }

        function disconnectWallet() {
            isConnected = false;
            document.getElementById('connectBtn').classList.remove('connected');
            document.getElementById('btnText').textContent = 'Connect Wallet';
            document.getElementById('actionButton').disabled = true;
            document.getElementById('actionButton').innerHTML = '<i class="fas fa-lock"></i> CONNECT WALLET';
            document.getElementById('approveBtn').style.display = 'none';
            document.getElementById('approvalSteps').style.display = 'none';
            
            document.getElementById('usdtBalance').textContent = '--';
            document.getElementById('sigmaBalance').textContent = '--';
            document.getElementById('sigmaBalanceInr').textContent = '--';
            document.getElementById('polBalance').textContent = '--';
            document.getElementById('buyRate').textContent = '--';
            document.getElementById('sellRate').textContent = '--';
            document.getElementById('statusMessage').innerHTML = '';
            
            // Hide referral box on disconnect
            document.getElementById('referralBox').classList.add('hidden');
        }

        async function loadData() {
            if (!isConnected || !userAddress) return;
            
            try {
                const [rate, sRate, sigmaBal, usdtBal, polBal, userStruct] = await Promise.all([
                    sigmaContract.currentRate(),
                    sigmaContract.getSellRate(),
                    sigmaContract.balanceOf(userAddress),
                    usdtContract.balanceOf(userAddress),
                    provider.getBalance(userAddress),
                    sigmaContract.users(userAddress).catch(() => null)
                ]);
                
                buyRate = parseFloat(ethers.formatUnits(rate, 6));
                sellRate = parseFloat(ethers.formatUnits(sRate, 6));
                
                if (userStruct) {
                    lastBuyTimestamp = Number(userStruct.lastBuyTimestamp);
                }
                
                document.getElementById('buyRate').textContent = buyRate.toFixed(6) + ' USDT';
                document.getElementById('sellRate').textContent = sellRate.toFixed(6) + ' USDT';
                document.getElementById('buyRateInr').textContent = '≈ ₹' + (buyRate * INR_RATE).toFixed(2);
                document.getElementById('sellRateInr').textContent = '≈ ₹' + (sellRate * INR_RATE).toFixed(2);
                
                const usdtBalanceNum = parseFloat(ethers.formatUnits(usdtBal, 6));
                const sigmaBalanceNum = parseFloat(ethers.formatEther(sigmaBal));
                const polBalanceNum = parseFloat(ethers.formatEther(polBal));
                
                document.getElementById('usdtBalance').textContent = usdtBalanceNum.toFixed(2) + ' USDT';
                document.getElementById('sigmaBalance').textContent = sigmaBalanceNum.toFixed(2) + ' SIG6';
                
                const sigmaInrValue = sigmaBalanceNum * sellRate * INR_RATE;
                document.getElementById('sigmaBalanceInr').textContent = '≈ ₹' + sigmaInrValue.toFixed(2);
                
                document.getElementById('polBalance').textContent = polBalanceNum.toFixed(4) + ' POL';
                
                // ===== SHOW REFERRAL BOX ONLY AFTER FIRST PURCHASE =====
                if (userStruct && userStruct.hasBought) {
                    document.getElementById('referralBox').classList.remove('hidden');
                    const link = window.location.origin + window.location.pathname + '?ref=' + userAddress;
                    document.getElementById('referralLink').value = link;
                } else {
                    document.getElementById('referralBox').classList.add('hidden');
                }
                
                updateCooldownUI();
                calculate();
                
            } catch (error) {
                console.error("Load error:", error);
            }
        }

        function updateCooldownUI() {
            const now = Math.floor(Date.now() / 1000);
            
            const sellDiff = now - lastSellTimestamp;
            const sellRemaining = Math.max(0, 180 - sellDiff);
            const sellBadge = document.getElementById('sellCooldownBadge');
            
            if (sellRemaining > 0) {
                const mins = Math.floor(sellRemaining / 60);
                const secs = sellRemaining % 60;
                sellBadge.innerHTML = `<i class="fas fa-hourglass-half"></i> Sell cooldown: ${mins}m ${secs}s`;
                sellBadge.className = 'cooldown-badge cooldown-danger';
            } else {
                sellBadge.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> Sell ready`;
                sellBadge.className = 'cooldown-badge';
            }

            const buyDiff = now - lastBuyTimestamp;
            const thirtyDays = 30 * 24 * 3600;
            const buyBadge = document.getElementById('buyCooldownBadge');
            
            if (lastBuyTimestamp === 0) {
                buyBadge.innerHTML = `<i class="fas fa-calendar-alt"></i> No buy yet`;
                buyBadge.className = 'cooldown-badge';
            } else if (buyDiff < thirtyDays) {
                const daysRem = Math.ceil((thirtyDays - buyDiff) / 86400);
                buyBadge.className = 'cooldown-badge cooldown-danger';
                buyBadge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 30-day lock: ${daysRem}d left`;
            } else {
                buyBadge.className = 'cooldown-badge';
                buyBadge.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> 30d lock passed`;
            }
        }

        async function calculate() {
            if (!isConnected) return;
            
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (isNaN(amount) || amount <= 0) {
                document.getElementById('calcValue').textContent = '0.00 USDT';
                document.getElementById('calcInr').textContent = '0.00 INR';
                document.getElementById('actionButton').disabled = true;
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalSteps').style.display = 'none';
                
                if (currentMode === 'buy') {
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-lock"></i> ENTER AMOUNT';
                } else {
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-lock"></i> ENTER AMOUNT';
                }
                return;
            }
            
            if (currentMode === 'buy') {
                const totalUsdt = amount * buyRate;
                const usdtWithTax = totalUsdt * 1.01;
                currentUSDTNeeded = usdtWithTax;
                
                document.getElementById('calcLabel').textContent = 'Total USDT to Pay:';
                document.getElementById('calcValue').textContent = usdtWithTax.toFixed(6) + ' USDT';
                document.getElementById('calcInr').textContent = '₹' + (usdtWithTax * INR_RATE).toFixed(2);
                
                if (userAddress === CREATOR_WALLET.toLowerCase()) {
                    document.getElementById('actionButton').disabled = true;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-ban"></i> CREATOR WALLET';
                    document.getElementById('approveBtn').style.display = 'none';
                    document.getElementById('approvalSteps').style.display = 'none';
                    return;
                }
                
                const usdtBal = await usdtContract.balanceOf(userAddress);
                const usdtBalNum = parseFloat(ethers.formatUnits(usdtBal, 6));
                
                if (usdtBalNum < usdtWithTax) {
                    document.getElementById('actionButton').disabled = true;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-exclamation-triangle"></i> INSUFFICIENT USDT';
                    document.getElementById('approveBtn').style.display = 'none';
                    document.getElementById('approvalSteps').style.display = 'none';
                    document.getElementById('statusMessage').innerHTML = `Need ${usdtWithTax.toFixed(2)} USDT, you have ${usdtBalNum.toFixed(2)} USDT`;
                    return;
                }
                
                await checkAllowance(usdtWithTax);
                
            } else {
                const totalUsdt = amount * sellRate;
                
                document.getElementById('calcLabel').textContent = 'Total USDT to Receive:';
                document.getElementById('calcValue').textContent = totalUsdt.toFixed(6) + ' USDT';
                document.getElementById('calcInr').textContent = '₹' + (totalUsdt * INR_RATE).toFixed(2);
                
                if (userAddress === CREATOR_WALLET.toLowerCase()) {
                    document.getElementById('actionButton').disabled = true;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-ban"></i> CREATOR WALLET';
                    document.getElementById('approveBtn').style.display = 'none';
                    document.getElementById('approvalSteps').style.display = 'none';
                    return;
                }
                
                const sigmaBal = await sigmaContract.balanceOf(userAddress);
                const sigmaBalNum = parseFloat(ethers.formatEther(sigmaBal));
                
                if (sigmaBalNum < amount) {
                    document.getElementById('actionButton').disabled = true;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-exclamation-triangle"></i> INSUFFICIENT SIG6';
                    document.getElementById('approveBtn').style.display = 'none';
                    document.getElementById('approvalSteps').style.display = 'none';
                    return;
                }
                
                const now = Math.floor(Date.now() / 1000);
                const sellDiff = now - lastSellTimestamp;
                
                if (sellDiff < 180) {
                    document.getElementById('actionButton').disabled = true;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-hourglass-half"></i> COOLDOWN ACTIVE';
                } else {
                    document.getElementById('actionButton').disabled = false;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-coins"></i> SELL SIGMA';
                }
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalSteps').style.display = 'none';
                document.getElementById('statusMessage').innerHTML = '';
            }
        }

        async function checkAllowance(usdtNeeded) {
            try {
                const allowance = await usdtContract.allowance(userAddress, SIGMA_ADDRESS);
                const allowanceNum = parseFloat(ethers.formatUnits(allowance, 6));
                
                if (allowanceNum < usdtNeeded - 0.000001) {
                    isApproved = false;
                    document.getElementById('approvalSteps').style.display = 'block';
                    document.getElementById('approveBtn').style.display = 'block';
                    document.getElementById('actionButton').disabled = true;
                    
                    document.getElementById('step1').className = 'step active';
                    document.getElementById('step1Status').innerHTML = 'Required: ' + usdtNeeded.toFixed(2) + ' USDT';
                    document.getElementById('step2').className = 'step';
                    document.getElementById('step2Status').innerHTML = 'Locked';
                    
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-lock"></i> APPROVE FIRST';
                    document.getElementById('statusMessage').innerHTML = '';
                } else {
                    isApproved = true;
                    document.getElementById('approvalSteps').style.display = 'block';
                    document.getElementById('approveBtn').style.display = 'none';
                    
                    document.getElementById('step1').className = 'step completed';
                    document.getElementById('step1Status').innerHTML = 'Approved: ' + allowanceNum.toFixed(2) + ' USDT';
                    document.getElementById('step2').className = 'step active';
                    document.getElementById('step2Status').innerHTML = 'Ready to buy';
                    
                    document.getElementById('actionButton').disabled = false;
                    document.getElementById('actionButton').innerHTML = '<i class="fas fa-shopping-cart"></i> BUY SIGMA';
                    document.getElementById('statusMessage').innerHTML = '';
                }
            } catch (error) {
                console.error("Allowance check error:", error);
            }
        }

        async function approveUSDT() {
            if (!isConnected) return;
            
            const btn = document.getElementById('approveBtn');
            const msg = document.getElementById('statusMessage');
            
            try {
                const usdtWei = ethers.parseUnits(currentUSDTNeeded.toFixed(6), 6);
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> APPROVING...';
                msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Please confirm in MetaMask...';
                
                const tx = await usdtContract.approve(SIGMA_ADDRESS, usdtWei);
                
                msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Waiting for confirmation...';
                const receipt = await tx.wait();
                
                msg.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i> USDT Approved Successfully!';
                
                document.getElementById('step1').className = 'step completed';
                document.getElementById('step1Status').innerHTML = 'Approved: ' + currentUSDTNeeded.toFixed(2) + ' USDT';
                document.getElementById('step2').className = 'step active';
                document.getElementById('step2Status').innerHTML = 'Ready to buy';
                
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('actionButton').disabled = false;
                document.getElementById('actionButton').innerHTML = '<i class="fas fa-shopping-cart"></i> BUY SIGMA';
                
                isApproved = true;
                
            } catch (error) {
                console.error("Approve error:", error);
                
                let errorMsg = "Approval failed";
                if (error.message.includes("user rejected")) {
                    errorMsg = "Approval rejected";
                }
                
                msg.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> ❌ ' + errorMsg;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'APPROVE USDT';
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('buyTab').className = mode === 'buy' ? 'tab active' : 'tab';
            document.getElementById('sellTab').className = mode === 'sell' ? 'tab active' : 'tab';
            
            document.getElementById('amount').value = '';
            document.getElementById('approveBtn').style.display = 'none';
            document.getElementById('approvalSteps').style.display = 'none';
            document.getElementById('statusMessage').innerHTML = '';
            calculate();
        }

        async function executeAction() {
            if (!isConnected) {
                connectWallet();
                return;
            }
            
            if (userAddress === CREATOR_WALLET.toLowerCase()) {
                document.getElementById('statusMessage').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> ❌ Creator wallet cannot trade!';
                return;
            }
            
            const amount = parseFloat(document.getElementById('amount').value);
            if (isNaN(amount) || amount <= 0) {
                alert("Enter valid amount");
                return;
            }
            
            const btn = document.getElementById('actionButton');
            const msg = document.getElementById('statusMessage');
            
            try {
                if (currentMode === 'buy') {
                    if (!isApproved) {
                        msg.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> Please approve USDT first';
                        return;
                    }
                    
                    const usdtWithTax = amount * buyRate * 1.01;
                    const usdtWei = ethers.parseUnits(usdtWithTax.toFixed(6), 6);
                    
                    msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buying SIGMA...';
                    btn.disabled = true;
                    
                    const upline = localStorage.getItem('sigma_referrer') || CREATOR_WALLET;
                    
                    const tx = await sigmaContract.buy(usdtWei, upline);
                    
                    msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Waiting for confirmation...';
                    const receipt = await tx.wait();
                    
                    msg.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i> Purchase Successful!';
                    
                    document.getElementById('step2').className = 'step completed';
                    document.getElementById('step2Status').innerHTML = 'Completed';
                    
                    setTimeout(async () => {
                        await loadData();
                        document.getElementById('amount').value = '';
                        document.getElementById('approvalSteps').style.display = 'none';
                        calculate();
                    }, 2000);
                    
                } else {
                    const now = Math.floor(Date.now() / 1000);
                    if ((now - lastSellTimestamp) < 180) {
                        alert(`Please wait ${180 - (now - lastSellTimestamp)} seconds before selling again`);
                        return;
                    }
                    
                    const sigmaWei = ethers.parseEther(amount.toString());
                    
                    msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Selling SIGMA...';
                    btn.disabled = true;
                    
                    const tx = await sigmaContract.sell(sigmaWei);
                    
                    msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Waiting for confirmation...';
                    const receipt = await tx.wait();
                    
                    lastSellTimestamp = Math.floor(Date.now() / 1000);
                    localStorage.setItem(`lastSell_${userAddress}`, lastSellTimestamp.toString());
                    
                    msg.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i> Sale Successful!';
                    
                    setTimeout(async () => {
                        await loadData();
                        document.getElementById('amount').value = '';
                        calculate();
                    }, 2000);
                }
            } catch (error) {
                console.error("Transaction error:", error);
                
                let errorMsg = "Transaction failed";
                if (error.message.includes("user rejected")) {
                    errorMsg = "Transaction rejected";
                } else if (error.message.includes("insufficient funds")) {
                    errorMsg = "Insufficient POL for gas";
                } else if (error.message.includes("Cooldown")) {
                    errorMsg = "3-minute cooldown active";
                }
                
                msg.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> ❌ ${errorMsg}`;
                btn.disabled = false;
            }
        }

        async function maxAmount() {
            if (!isConnected) {
                connectWallet();
                return;
            }
            
            if (currentMode === 'buy') {
                const usdtBal = await usdtContract.balanceOf(userAddress);
                const usdtNum = parseFloat(ethers.formatUnits(usdtBal, 6));
                const maxSigma = usdtNum / (buyRate * 1.01);
                document.getElementById('amount').value = maxSigma.toFixed(6);
            } else {
                const sigmaBal = await sigmaContract.balanceOf(userAddress);
                document.getElementById('amount').value = parseFloat(ethers.formatEther(sigmaBal)).toFixed(6);
            }
            
            calculate();
        }

        function setTransferToken(token) {
            transferToken = token;
            document.querySelectorAll('.token-opt').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            updateTransferBalance();
        }

        async function updateTransferBalance() {
            if (!isConnected) return;
            
            let balance = 0;
            if (transferToken === 'SIG6') {
                const bal = await sigmaContract.balanceOf(userAddress);
                balance = parseFloat(ethers.formatEther(bal));
            } else if (transferToken === 'USDT') {
                const bal = await usdtContract.balanceOf(userAddress);
                balance = parseFloat(ethers.formatUnits(bal, 6));
            } else {
                const bal = await provider.getBalance(userAddress);
                balance = parseFloat(ethers.formatEther(bal));
            }
            
            document.getElementById('transferBalance').textContent = 
                `Balance: ${balance.toFixed(6)} ${transferToken}`;
        }

        function maxTransfer() {
            const balText = document.getElementById('transferBalance').textContent;
            const match = balText.match(/Balance: ([\d.]+)/);
            if (match) {
                document.getElementById('transferAmount').value = match[1];
            }
        }

        function pasteAddress() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('recipientAddress').value = text;
            });
        }

        async function executeTransfer() {
            if (!isConnected) {
                connectWallet();
                return;
            }
            
            const to = document.getElementById('recipientAddress').value.trim();
            if (!ethers.isAddress(to)) {
                document.getElementById('transferStatus').textContent = 'Invalid address';
                return;
            }
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            if (isNaN(amount) || amount <= 0) {
                document.getElementById('transferStatus').textContent = 'Invalid amount';
                return;
            }
            
            const btn = document.getElementById('transferButton');
            btn.disabled = true;
            document.getElementById('transferStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transferring...';
            
            try {
                if (transferToken === 'SIG6') {
                    const wei = ethers.parseEther(amount.toString());
                    
                    // ✅ Using p2pTransfer function
                    const tx = await sigmaContract.p2pTransfer(to, wei);
                    await tx.wait();
                    
                    document.getElementById('transferStatus').innerHTML = 
                        '<i class="fas fa-check-circle" style="color:var(--success)"></i> P2P Transfer successful!';
                } else if (transferToken === 'USDT') {
                    const usdt = ethers.parseUnits(amount.toString(), 6);
                    const tx = await usdtContract.transfer(to, usdt);
                    await tx.wait();
                    document.getElementById('transferStatus').innerHTML = 
                        '<i class="fas fa-check-circle" style="color:var(--success)"></i> USDT Transfer successful!';
                } else {
                    const wei = ethers.parseEther(amount.toString());
                    const tx = await signer.sendTransaction({ to, value: wei });
                    await tx.wait();
                    document.getElementById('transferStatus').innerHTML = 
                        '<i class="fas fa-check-circle" style="color:var(--success)"></i> POL Transfer successful!';
                }
                
                setTimeout(() => {
                    document.getElementById('transferStatus').innerHTML = '';
                    document.getElementById('transferAmount').value = '';
                    document.getElementById('recipientAddress').value = '';
                    updateTransferBalance();
                }, 3000);
                
            } catch (error) {
                console.error("Transfer error:", error);
                document.getElementById('transferStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> Transfer failed: ' + error.message;
            } finally {
                btn.disabled = false;
            }
        }

        function copyContract() {
            navigator.clipboard.writeText(SIGMA_ADDRESS);
            alert("New contract address copied!");
        }

        function copyReferral() {
            const link = document.getElementById('referralLink');
            link.select();
            navigator.clipboard.writeText(link.value);
            alert("Referral link copied!");
        }

        function copyWallet() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress);
                alert("Wallet address copied!");
            }
        }
    </script>
</body>
</html>
