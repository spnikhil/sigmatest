<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA_SIX (SIG6) Exchange</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-950 text-white font-sans min-h-screen">

    <div class="max-w-md mx-auto p-4">
        <div class="flex flex-col py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">SIG6 PORTAL</h1>
                <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-full font-bold transition-all shadow-lg shadow-blue-900/20">Connect Wallet</button>
            </div>
            <p id="walletAddr" class="text-[10px] text-gray-500 text-right mt-2 font-mono"></p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="glass p-5 rounded-2xl border border-slate-800 shadow-xl">
                <p class="text-emerald-400 text-xs font-bold uppercase tracking-wider mb-1">Buy Rate</p>
                <h2 id="buyRateUsdt" class="text-2xl font-bold tracking-tight">$0.0000</h2>
                <p id="buyRateInr" class="text-sm text-gray-500 font-medium">₹0.00</p>
            </div>
            <div class="glass p-5 rounded-2xl border border-slate-800 shadow-xl">
                <p class="text-rose-400 text-xs font-bold uppercase tracking-wider mb-1">Sell Rate</p>
                <h2 id="sellRateUsdt" class="text-2xl font-bold tracking-tight">$0.0000</h2>
                <p id="sellRateInr" class="text-sm text-gray-500 font-medium">₹0.00</p>
            </div>
        </div>

        <div class="glass p-6 rounded-3xl border border-slate-800 shadow-2xl relative overflow-hidden">
            <div class="flex space-x-2 mb-8 p-1 bg-slate-900/50 rounded-xl">
                <button onclick="setMode('buy')" id="buyTab" class="flex-1 py-2 rounded-lg transition-all font-bold text-sm bg-blue-600 text-white">BUY</button>
                <button onclick="setMode('sell')" id="sellTab" class="flex-1 py-2 rounded-lg transition-all font-bold text-sm text-gray-400">SELL</button>
            </div>

            <div class="space-y-5">
                <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-800">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">You Pay</label>
                    <div class="flex items-center">
                        <input id="inputAmount" type="number" placeholder="0.0" class="w-full bg-transparent text-2xl font-bold focus:outline-none">
                        <span id="inputSymbol" class="text-lg font-black text-gray-400 ml-2">USDT</span>
                    </div>
                </div>

                <div class="flex justify-center -my-3 relative z-10">
                    <div class="bg-slate-800 p-2 rounded-full border border-slate-700 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                    </div>
                </div>

                <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-800">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">You Receive (Est.)</label>
                    <div class="flex items-center">
                        <input id="outputAmount" type="number" placeholder="0.0" readonly class="w-full bg-transparent text-2xl font-bold text-gray-500 focus:outline-none">
                        <span id="outputSymbol" class="text-lg font-black text-gray-400 ml-2">SIG6</span>
                    </div>
                </div>

                <button id="actionBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 py-5 rounded-2xl font-black text-lg transition-all transform active:scale-95 shadow-xl shadow-blue-900/30">
                    CONNECT WALLET
                </button>
                <p id="statusMsg" class="text-center text-xs font-medium text-yellow-500 animate-pulse"></p>
            </div>
        </div>
    </div>

    <script>
        const SIG6_ADDR = "0x52fD2a4da50d34566224DC65Da4Ba6C29c07A3DC";
        const USDT_ADDR = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F"; // Polygon USDT
        
        const ABI = [
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function buy(uint256 _usdtAmount, address _upline) external",
            "function sell(uint256 _sigmaAmount) external"
        ];

        const USDT_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        let provider, signer, mode = 'buy', inrRate = 88.50;

        async function init() {
            // Fetch INR Price
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                inrRate = data.rates.INR;
            } catch(e) {}
            
            refreshRates();
            setInterval(refreshRates, 10000);
        }

        async function refreshRates() {
            const rpcs = ["https://polygon-rpc.com", "https://rpc-mainnet.maticvigil.com", "https://1rpc.io/matic"];
            let loaded = false;

            for(let url of rpcs) {
                try {
                    const tempProv = new ethers.JsonRpcProvider(url);
                    const contract = new ethers.Contract(SIG6_ADDR, ABI, tempProv);
                    
                    const [bRaw, sRaw] = await Promise.all([
                        contract.currentRate(),
                        contract.getSellRate()
                    ]);

                    // Formula fix: Base rate 10500 is actually 0.0105 USDT if scaled by 1e6
                    // Your contract uses: tokensToMint = (netUsdt * 1e18) / currentRate
                    // If currentRate is 10500, then for 1 USDT (1e6), it mints ~95 tokens.
                    const bUsdt = Number(bRaw) / 1e6; 
                    const sUsdt = Number(sRaw) / 1e6;

                    document.getElementById('buyRateUsdt').innerText = `$${bUsdt.toFixed(4)}`;
                    document.getElementById('sellRateUsdt').innerText = `$${sUsdt.toFixed(4)}`;
                    document.getElementById('buyRateInr').innerText = `₹${(bUsdt * inrRate).toFixed(2)}`;
                    document.getElementById('sellRateInr').innerText = `₹${(sUsdt * inrRate).toFixed(2)}`;
                    
                    loaded = true;
                    break;
                } catch(e) { console.error("RPC fail:", url); }
            }
            if(!loaded) document.getElementById('statusMsg').innerText = "Network Error: Refresh Page";
        }

        function setMode(m) {
            mode = m;
            const isBuy = m === 'buy';
            document.getElementById('buyTab').className = isBuy ? 'flex-1 py-2 rounded-lg transition-all font-bold text-sm bg-blue-600 text-white' : 'flex-1 py-2 rounded-lg transition-all font-bold text-sm text-gray-400';
            document.getElementById('sellTab').className = !isBuy ? 'flex-1 py-2 rounded-lg transition-all font-bold text-sm bg-blue-600 text-white' : 'flex-1 py-2 rounded-lg transition-all font-bold text-sm text-gray-400';
            document.getElementById('inputSymbol').innerText = isBuy ? 'USDT' : 'SIG6';
            document.getElementById('outputSymbol').innerText = isBuy ? 'SIG6' : 'USDT';
            if(signer) document.getElementById('actionBtn').innerText = isBuy ? 'BUY SIG6' : 'SELL SIG6';
            document.getElementById('inputAmount').value = '';
            document.getElementById('outputAmount').value = '';
        }

        document.getElementById('inputAmount').oninput = (e) => {
            const val = parseFloat(e.target.value) || 0;
            const bRate = parseFloat(document.getElementById('buyRateUsdt').innerText.replace('$',''));
            const sRate = parseFloat(document.getElementById('sellRateUsdt').innerText.replace('$',''));
            
            if(mode === 'buy') {
                document.getElementById('outputAmount').value = (val / bRate).toFixed(6);
            } else {
                document.getElementById('outputAmount').value = (val * sRate).toFixed(6);
            }
        };

        document.getElementById('connectBtn').onclick = async () => {
            if(!window.ethereum) return alert("Install MetaMask");
            provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            document.getElementById('connectBtn').innerText = "Connected";
            document.getElementById('walletAddr').innerText = `Wallet: ${accounts[0]}`;
            setMode(mode);
        };

        document.getElementById('actionBtn').onclick = async () => {
            if(!signer) return document.getElementById('connectBtn').click();
            
            const amount = document.getElementById('inputAmount').value;
            if(!amount || amount <= 0) return alert("Enter amount");
            
            const status = document.getElementById('statusMsg');
            const contract = new ethers.Contract(SIG6_ADDR, ABI, signer);

            try {
                if(mode === 'buy') {
                    const usdtContract = new ethers.Contract(USDT_ADDR, USDT_ABI, signer);
                    const amountWei = ethers.parseUnits(amount, 6); // USDT is 6 decimals
                    
                    status.innerText = "Checking Allowance...";
                    const allow = await usdtContract.allowance(await signer.getAddress(), SIG6_ADDR);
                    
                    if(allow < amountWei) {
                        status.innerText = "Approving USDT...";
                        const txA = await usdtContract.approve(SIG6_ADDR, amountWei);
                        await txA.wait();
                    }
                    
                    status.innerText = "Confirming Purchase...";
                    const txB = await contract.buy(amountWei, "0x0000000000000000000000000000000000000000");
                    await txB.wait();
                    status.innerText = "Purchase Successful!";
                } else {
                    const amountWei = ethers.parseUnits(amount, 18); // SIG6 is 18 decimals
                    status.innerText = "Confirming Sale...";
                    const txS = await contract.sell(amountWei);
                    await txS.wait();
                    status.innerText = "Sale Successful!";
                }
            } catch(e) {
                status.innerText = "Transaction Failed!";
                console.error(e);
            }
        };

        init();
    </script>
</body>
</html>
